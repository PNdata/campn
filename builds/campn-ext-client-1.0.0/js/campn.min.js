function uid(){return"xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})}function clone(a){if("object"!=typeof a||null==a)return a;var b=new a.constructor;for(var c in a)b[c]=clone(a[c]);return b}function DataReferential(a,b){this._schema=a,this._keyName=b,this._data=[],this._loaded=!1,this.schema=function(a){return null!=a?(this._schema=a,this):this._schema},this.keyName=function(a){return null!=a?(this._keyName=a,this):this._keyName},this.data=function(a){return null!=a?(this._data=a,this):this._data},this.loaded=function(a){return null!=a?(this._loaded=a,this):this._loaded},this.load=function(){var a=this;return App.Server.get("/schema/"+this.schema()+"/data",{data:{keyName:b}},function(b){a.loaded(!0),a.data(b)})},this.row=function(a){var b=null;return $.each(this.data(),function(c,d){return d.v==a?(b=d,!1):void 0}),b}}function Session(){this._queries=[],this._mode=null,this._name=null,this._id=null,this._saved=!1,this._mode="full",this._computeOnTheFly=!0,this._exclQuery=null,this._excludeQueries=!0,this._plugin={},this.plugin=function(a,b){return null!=a&&null!=b?(this._plugin={name:a,data:b},this):this._plugin},this.queriesComputed=function(){var a=!0;return $.each(this.queries(),function(b,c){return c.computed()?void 0:(a=!1,!1)}),a},this.mode=function(a){return null!=a?(this._mode=a,this):this._mode},this.computeOnTheFly=function(a){return null!=a?(this._computeOnTheFly=a,this):this._computeOnTheFly},this.excludeQueries=function(a){return null!=a?(this._excludeQueries=a,this):this._excludeQueries},this.name=function(a){return null!=a?(this._name=a,this):this._name},this.id=function(a){return null!=a?(this._id=a,this):this._id},this.saved=function(a){return null!=a?(this._saved=a,this):this._saved},this.exclQuery=function(a){return null!=a?(this._exclQuery=a,this):this._exclQuery},this.isSaved=function(){return this._saved},this.load=function(a){var b=this;App.Server.session.load(token,a(function(){b._mode=data.mode,b._queries=data.queries}))},this.toJSON=function(){var a=[];return $.each(this.queries(),function(b,c){a.push(c.toJSON())}),{id:this.id(),name:this.name(),queries:a}},this.toString=function(){var a="",b=this.queries();return a+=_.map(b,function(a){return(b.length>1?"(":"")+a.toString()+(b.length>1?")":"")}).join(" + "),this.exclQuery()&&(a+=" - ("+this.exclQuery().toString()+")"),a},this.synch=function(a,b){var c={queries:this.JSON()};Server.session.synch(this._token,JSON.stringify(c),a,b)},this.addQuery=function(a){return this.queries().push(a),a},this.query=function(a){var b;return $.each(this.queries(),function(c,d){d.id()==a&&(b=c)}),this.queries()[b]},this.popcount=function(){return _.reduce(this.queries(),function(a,b){return a+b.popcount()},0)},this.queries=function(){return this._queries},this.currentTarget=function(){return this.target(App.currentTarget)},this.exclQueryExists=function(){return null!=this.exclQuery()},this.removeQuery=function(a){$.ajax({url:App.SERVER_URL,method:"post",data:{c:"target-remove",sid:this._id,tid:a},async:!1}).done(function(){var b=this;$.each(b.targets(),function(c,d){return d.id()==a?void(b._targets=b.targets().unset(c)):void 0})})},this.kill=function(){$.ajax({url:App.SERVER_URL,method:"post",data:{c:"session-kill",sid:this._id},async:!1,success:function(a){}})},this.resetQueries=function(){this._queries=[]}}function Query(a){this.allowedProperties=["id","internalId","label","popcount","nodes","desc","excl","exclusivity","useExclusion"];for(key in a)if($.inArray(key,this.allowedProperties)>-1){var b=a[key];this["_"+key]=b}this._$parentE=$("#query-list"),this._$e=null,this._computed=!1,this.computed=function(a){return null!=a?(this._computed=a,this):this._computed},this._computing=!1,this.computing=function(a){return null!=a?(this._computing=a,this):this._computing},this._progression=0,this.progression=function(a){return null!=a?(this._progression=a,this):this._progression},this._limit=null,this.limit=function(a){return null!=a?(this._limit=a,this):this._limit},this._selected=!1,this.selected=function(a){return null!=a?(this._selected=a,this):this._selected},this.exclusivity=function(a){return null!=a?(this._exclusivity=a,this):this._exclusivity},this.useExclusion=function(a){return null!=a?(this._useExclusion=a,this):this._useExclusion},this.nodesComputed=function(){var a=!0;return $.each(this.nodes(),function(b,c){return c.computed()?void 0:(a=!1,!1)}),a},this.toJSON=function(){var a=[];return $.each(this.nodes(),function(b,c){a.push(c.toJSON())}),{id:this.id(),order:this.order(),internalId:this.internalId(),desc:this.desc(),excl:this.excl(),label:this.label(),exclusivity:this.exclusivity(),useExclusion:this.useExclusion(),nodes:a}},this.toString=function(){return this.mainNode().toString()},this.id=function(a){return null!=a?(this._id=a,this):this._id},this.internalId=function(a){return null!=a?(this._internalId=a,this):this._internalId},this.label=function(a){return null!=a?(this._label=a,this):this._label},this.excl=function(a){return null!=a?(this._excl=a,this):this._excl},this.desc=function(a){return null!=a?(this._desc=a,this):this._desc},this.popcount=function(a){return null!=a?(this._popcount=a,this):this._popcount},this.nodes=function(a){return null!=a?(this._nodes=a,this):this._nodes},this.order=function(){return null!=App.session.exclQuery()?this.excl()?0:App.session.queries().indexOf(this)+1:App.session.queries().indexOf(this)},this.previous=function(){var a=this,b=null;return $.each(App.session.queries(),function(c,d){return a.id()==d.id()&&c<App.session.queries().length+1?(b=App.session.queries()[c-1],!1):void 0}),b},this.hasNext=function(){return null!=this.next()},this.next=function(){var a=this,b=null;return $.each(App.session.queries(),function(c,d){return a.id()==d.id()&&c<App.session.queries().length-1?(b=App.session.queries()[c+1],!1):void 0}),b},this.mainNode=function(){return this.nodes()[0]},this.node=function(a){var b;return $.each(this.nodes(),function(c,d){return d.id()==a?void(b=d):void 0}),b},this.nodeByInternalId=function(a){var b;return $.each(this.nodes(),function(c,d){return d.internalId()==a?void(b=d):void 0}),b},this.addNode=function(a){return this.nodes().push(a),a},this.removeNode=function(a){var b=this;$.each(a.children(),function(b,c){c.parent(a.parent())});var c=a;$.each(a.children(),function(b,d){a.parent().children(a.parent().children().insert(a.parent().children().indexOf(c),d)),c=d}),a.parent().children(a.parent().children().unset(a.parent().children().indexOf(a))),b.nodes(b.nodes().unset(b.nodes().indexOf(a)))},this.rebuildLinks=function(){var a=this;$.each(this.nodes(),function(a,b){b.hasChildren()?b.link():b.unlink()}),$.each(this.$tree().find("canvas.node-link"),function(b,c){void 0==a.node($(c).attr("data-id"))&&this.remove()})},this.removeNodeByIndex=function(a){this.nodes(this.nodes().unset(a))},this.$listItem=function(){var a=this,b=$("#query-list").children('li[data-id="'+this.id()+'"]');if(!b.exists()){b=$('<li class="query-item" data-id="'+this.id()+'"></li>');var c=$('<div class="query-details"></div>');c.append('<div class="query-label">'+this.label()+"</div>").append('<div class="query-popcount"><i class="icon-users"></i> <span class="query-popcount-number">-</span></div>').click(function(){a.select()});var d=$('<div class="query-progressbar"></div>');c.append(d),d.kendoProgressBar({type:"percent",showStatus:!1,animation:{duration:600}});var e=$('<div class="query-commands"></div>');e.addClass("flex"),$.each(App.UI.query,function(b,c){if(c.enabled&&(c.excl&&a.excl()||!a.excl())){var d=$('<button title="'+c.tooltip+'" class="k-button query-command-'+b+'"><i class="icon-'+c.icon+'"></i></button>');d.click(a.commands()[b]),e.append(d)}}),b.append(c).append(e).hide(),b.addClass("query-item"+(this.excl()?"-excl":"-default"))}return b},this.$toExcl=function(){return this.$listItem().removeClass("query-item-default").addClass("query-item-excl"),this},this.$toDefault=function(){return this.$listItem().removeClass("query-item-excl").addClass("query-item-default"),this},this.commandButton=function(a){return this.$listItem().children(".query-commands").children("button.query-command-"+a)},this.disableCommand=function(a){return this.commandButton(a).off("click").addClass("disabled"),this},this.enableCommand=function(a){var b=this;return this.commandButton(a).on("click",b.commands()[a]).removeClass("disabled"),this},this.disableCommands=function(){var a=this;return $.each(this.commands(),function(b,c){a.disableCommand(b)}),this},this.enableCommands=function(){var a=this;return $.each(this.commands(),function(b,c){a.enableCommand(b)}),this},this.dependentQueries=function(){var a=[];if(this.excl())a=App.session.queries();else if(this.hasNext())for(var b=this;b.hasNext();)b=b.next(),a.push(b);return a},this.commands=function(){var a=this;return{copy:function(){},save:function(){App.Controller.Query.openSaveModel(a)},load:function(){App.Controller.Query.openLoadModel(a)},edit:function(){App.Controller.Query.dialog(a)},remove:function(){App.Controller.Query.remove(a)}}},this.$tree=function(){var a=$('.query-tree[data-id="'+this.id()+'"]');return a.exists()?a:$('<div class="query-tree" data-id="'+this.id()+'"></div>')},this.render=function(a,b){if(void 0==a||null==a)var a=!0;var c=this;if($("#query-list").children("li.empty").remove(),c.excl()?$("#query-list").prepend(c.$listItem()):$("#query-list").append(c.$listItem()),void 0==b)var b=function(){};return a?c.$listItem().effect("slide",b):c.$listItem().show(b),$("#query-wrapper").append(c.$tree()),this},this.remove=function(){this.$listItem().fadeOut("slow"),this.$tree().fadeOut("slow")},this.$details=function(){return this.$listItem().children(".query-details")},this.$popcount=function(){return this.$details().children(".query-popcount")},this.$loading=function(){return this.$popcount().children(".query-loading").exists()||this.$popcount().children(".query-popcount-number").replaceWith($('<span class="query-loading"></span>')),this.$popcount().children(".query-loading")},this.$progressbar=function(){return this.$details().children(".query-progressbar")},this.progressbar=function(a){this.$progressbar().data("kendoProgressBar").value(a)},this.progress_=function(){var a=this.nodes().length,b=0;return $.each(this.nodes(),function(a,c){c.computed()&&b++}),b/a},this.progress=function(a){return this.$loading().text(a+"%"),this.progressbar(a),this},this.resetProgress=function(){this.progressbar(0)},this.showProgressbar=function(){return this.$progressbar().css("visibility","visible"),this},this.hideProgressbar=function(){return this.$progressbar().css("visibility","hidden"),this},this.updateLabel=function(){this.$listItem().find(".query-label").text(this.label())},this.updatePopcount=function(a){var b=this.$popcount().find(".query-loading"),c=this;b.fadeOut(500,function(){b.remove();var d=$('<span class="query-popcount-number">'+$.formatNumber(c.popcount(),{format:"#,##0",locale:"fr"})+"</span>").hide();c.$popcount().append(d),d.fadeIn("slow");var e=c.$listItem().children(".query-details").css("backgroundColor");c.$listItem().children(".query-details").animate({backgroundColor:"#FE2339"},500,function(){$(this).animate({backgroundColor:e},500,function(){$(this).removeAttr("style"),a()})})})},this.unselect=function(){this.$listItem().removeClass("query-item-selected"),this.selected(!1)},this.select=function(){var a=this;return null!=App.session.exclQuery()&&App.session.exclQuery().unselect(),$.each(App.session.queries(),function(a,b){b.unselect()}),this.$listItem().addClass("query-item-selected"),$(".query-tree").hide(),$('.query-tree[data-id="'+a.id()+'"]').show(),this.selected(!0),this},this.compute=function(a,b){var c=this,d=[];this.computing(!0),this.mainNode().hasChildren()?$.each(this.mainNode().clsBranch(),function(a,b){d.push(b.toJSON())}):d.push(this.mainNode().toJSON());var e=[];App.session.excludeQueries()&&(this.excl()||(null!=App.session.exclQuery()&&this.useExclusion()&&e.push(App.session.exclQuery().toJSON()),this.exclusivity()&&$.each(App.session.queries(),function(a,b){a<App.session.queries().indexOf(c)&&e.push(b.toJSON())}))),App.Server.Query.compute(this.toJSON(),d,e,function(b){c.popcount(b.count).computed(!0).computing(!1),a(b)},function(a){b(a)})}}function Node(a){this.allowedProperties=["id","label","popcount","criteria","parent","query","children"],this.defaults={id:uid(),label:null,popcount:null,criteria:[],parent:null,query:null,children:[]},this._internalId=null;for(key in a)if($.inArray(key,this.allowedProperties)>-1){var b=a[key];this["_"+key]=b}this._internalId=null,this._computed=!1,this.computed=function(a){return null!=a?(this._computed=a,this):this._computed},this._computing=!1,this.computing=function(a){return null!=a?(this._computing=a,this):this._computing},this.criteriaComputed=function(){var a=!0;return $.each(this.criteria(),function(b,c){return c.computed()?void 0:(a=!1,!1)}),a},this.toJSON=function(){var a=[];$.each(this.criteria(),function(b,c){a.push(c.toJSON())});var b=[];return $.each(this.children(),function(a,c){b.push(c.id())}),{id:this.id(),label:this.label(),criteria:a,children:b,parent:this.hasParent()?this.parent().id():null}},this.toString=function(){var a="",b=this.criteria(),c=_.map(b,function(a){return a.toString()}).join(" et ");c&&(a+=(b.length>1?"(":"")+c+(b.length>1?")":""));var d=this.children(),e=_.map(d,function(a){return a.toString()}).join(" ou ");return e&&(a+=" et "+(d.length>1?"(":"")+e+(d.length>1?"(":"")),a},this.id=function(a){return null!=a?(this._id=a,this):this._id},this.internalId=function(a){return null!=a?(this._internalId=a,this):this._internalId},this.parent=function(a){return null!=a?(this._parent=a,this):this._parent},this.children=function(a){return null!=a?(this._children=a,this):this._children},this.query=function(a){return null!=a?(this._query=a,this):this._query},this.label=function(a){return null!=a?(this._label=a,this):this._label},this.popcount=function(a){return null!=a?(this._popcount=a,this):this._popcount},this.criteria=function(a){return null!=a?(this._criteria=a,this):this._criteria},this.genLabel=function(){if(this.hasParent())var a=this.parent();else var a=null;void 0===a&&(a=null);(null!=a?this.node(a).frontId()+"-":"")+App.newFrontId(this.frontId(),null!=a?this.node(a).frontId():0);return label},this.axis=function(){return{x:this.hasParent()?this.parent().axis().x+1:1,y:this.hasPrevious()?this.previous().axis().y+1:1}},this.position=function(){var a={};if(this.hasParent()){this.parent().clsBranch().length;1==this.parent().children().length?a.top=this.parent().$e().pos("top"):this.parent().children().length>1&&(this.previous().hasChildren()?a.top=this.previous().lastOfBranch().$e().pos("top")+180+10:a.top=this.previous().$e().pos("top")+180+10),a.left=this.parent().$e().pos("left")+270+10}else a.top=10,a.left=20;return a},this.level=function(){return this.hasParent()?this.parent().level()+"-"+this.axis().y:"1"},this.child=function(a){var b;return $.each(this.children(),function(c,d){return d.id()==a?void(b=d):void 0}),b},this.hasChildren=function(){return this.children().length>0},this.first=function(){var a=null;return this.hasChildren()&&(a=this.children()[0]),a},this.last=function(){var a=null;return this.hasChildren()&&(a=this.children()[this.children().length-1]),a},this.hasPrevious=function(){return null!=this.previous()},this.previous=function(){var a=this,b=null;return a.hasParent()&&a.parent().hasChildren()&&$.each(a.parent().children(),function(c,d){return a.id()==d.id()&&c<a.parent().children().length+1?void(b=a.parent().children()[c-1]):void 0}),b},this.hasNext=function(){return null!=this.next()},this.next=function(){var a=this,b=null;return a.hasParent()&&a.parent().hasChildren()&&$.each(a.parent().children(),function(c,d){return a.id()==d.id()&&c<a.parent().children().length-1?void(b=a.parent().children()[c+1]):void 0}),b},this.branch=function(){var a=[];return $.each(this.children(),function(b,c){a.push(c),a=a.concat(c.branch())}),a},this.clsChildren=function(){var a=[],b=this;return $.each(b.children(),function(b,c){c.hasChildren()||a.push(c)}),a},this.clsBranch=function(){var a=[],b=this;return $.each(b.branch(),function(b,c){c.hasChildren()||a.push(c)}),a},this.clsNoEmptyBranch=function(){var a=[];return $.each(this.branch(),function(b,c){c.criteria().length>0&&!c.hasChildren()&&a.push(c)}),a},this.firstOfBranch=function(){var a=null,b=this.clsBranch();return b.length>0&&(a=b[0]),a},this.lastOfBranch=function(){var a=null,b=this.clsBranch();return b.length>0&&(a=b[b.length-1]),a},this.hasParent=function(){return null!=this.parent()},this.criterion=function(a){var b;return $.each(this.criteria(),function(c,d){return d.id()==a?void(b=d):void 0}),b},this.addCriterion=function(a){this.criteria().push(a)},this.emptyCriteria=function(){this._criteria=[],this.$criteria().empty()},this.removeCriterion=function(a){this.criteria(this.criteria().unset(this.criteria().indexOf(a)))},this.removeCriterionByIndex=function(a){this.nodes(this.criteria().unset(a))},this.$e=function(){return $('.node[data-id="'+this.id()+'"]')},this.build$e=function(){var a=this,b=$('<div class="node" data-id="'+this.id()+'"></div>'),c=$('<div class="node-header"></div>'),d=$('<span class="node-label">'+this.label()+"</span>"),e=$('<div class="node-popcount"><i class="icon-users"></i> <span>'+(null==this.popcount()?"-":$.formatNumber(this.popcount(),{format:"#,##0",locale:"fr"}))+"</span></div>");c.append(d).append(e);var f=$('<div class="node-criteria"></div>'),g=$('<div class="node-footer"></div>'),h=$('<div class="node-commands"></div>');$.each(App.UI.node,function(b,c){if((0!=a.query().nodes().indexOf(a)||"remove"!=b)&&c.enabled){var d=$('<button id="node-command-'+b+'" title="'+c.tooltip+'" class="k-button node-command-'+b+'"><i class="icon-'+c.icon+'"></i></button>').click(a.commands()[b]).hover(function(){$(this)},function(){$(this)});h.append(d)}});var i=$('<div class="node-level">'+this.level()+"</div>");g.append(h).append(i),b.append(c).append(f).append(g);var j,k;if(this.hasParent()){this.parent().clsBranch().length;1==this.parent().children().length?j=this.parent().$e().pos("top"):this.parent().children().length>1&&(j=this.previous().hasChildren()?this.previous().lastOfBranch().$e().pos("top")+200+20:this.previous().$e().pos("top")+200+20),j=this.hasPrevious()?this.previous().hasChildren()?this.previous().lastOfBranch().$e().pos("top")+200+20:this.previous().$e().pos("top")+200+20:this.parent().$e().pos("top"),k=this.parent().$e().pos("left")+270+10}else j=20,k=20;return b.pos("top",j).pos("left",k),b},this.$header=function(){return this.$e().children(".node-header")},this.$popcount=function(){return this.$header().children(".node-popcount")},this.$label=function(){return this.$header().children(".node-label")},this.$criteria=function(){return this.$e().children(".node-criteria")},this.$footer=function(){return this.$e().children(".node-footer")},this.$commands=function(){return this.$footer().children(".node-commands")},this.$level=function(){return this.$footer().children(".node-level")},this.commandButton=function(a){return this.$e().children(".node-footer").children(".node-commands").children("button.node-command-"+a)},this.disableCommand=function(a){this.commandButton(a).off("click").addClass("disabled")},this.enableCommand=function(a){var b=this;this.commandButton(a).on("click",b.commands()[a]).removeClass("disabled")},this.disableCommands=function(){var a=this;$.each(this.commands(),function(b,c){a.disableCommand(b)})},this.enableCommands=function(){var a=this;$.each(this.commands(),function(b,c){a.enableCommand(b)})},this.commands=function(){var a=this;return{copy:function(){},save:function(){App.Controller.Node.openSaveModel(a)},load:function(){App.Controller.Node.openLoadModel(a)},addCriterion:function(){App.Controller.Criterion.add(a)},edit:function(){App.Controller.Node.edit(a)},remove:function(){App.Controller.Node["delete"](a)},addNode:function(){App.Controller.Node.add(a.query(),null,a)}}},this.pos=function(a,b){return null!=b?(this.$e().pos(a,b),this.$e()):this.$e().pos(a)},this.addCriterion=function(a){return a.node(this),this._criteria.push(a),a},this.select=function(){$.each(this.query().nodes(),function(a,b){b.$e().removeClass("node-selected")}),this.$e().addClass("node-selected")},this.loading=function(){var a=$('<span class="node-loading"></span>');return this.$popcount().children("span").replaceWith(a),this},this.updateCount=function(){var a=this.$popcount().find(".node-loading"),b=this;a.fadeOut(500,function(){if(a.remove(),null!=b.popcount())var c=$("<span>"+$.formatNumber(b.popcount(),{format:"#,##0",locale:"fr"})+"</span>").hide();else var c=$("<span>-</span>").hide();b.$popcount().append(c),c.fadeIn(500);var c=b.$popcount(),d=c.css("backgroundColor");c.animate({backgroundColor:"#FE2339"},1e3).animate({backgroundColor:d},500)})},this.computeFrom=function(a){var b=null==a?this:a;b.loading();var c=b.compute(!0);c.done(function(){return b.updateCount(),b.hasChildren()&&b.computeFrom(b.first()),b.hasNext()?(b.next().loading(),void b.computeFrom(b.next())):c})},this.compute=function(a,b){var c=this,d=[];if(this.computing(!0),this.hasPrevious())for(var e=this.previous();null!=e;)d.push(e.toJSON()),e=e.previous();App.Server.Node.compute(this.toJSON(),this.hasParent()?[this.parent().toJSON()]:[],d,function(b){c.popcount(b.count).computed(!0).computing(!1),a(b)},function(a){b(a)})},this.remove=function(a){var b=this,c=[];if(c.push(this.$e().hide("slide",{direction:this.hasPrevious()?"up":"left"},function(){$(this).remove()})),$.each(this.branch(),function(a,b){c.push(b.$e().animate({left:b.$e().pos("left")-280}))}),!this.hasChildren())for(var d=this.next();null!=d;){c.push(d.$e().animate({top:d.$e().pos("top")-200-20})),$.each(d.branch(),function(a,b){c.push(b.$e().animate({top:b.$e().pos("top")-200-20}))}),d=d.next()}for(var e=this.parent();null!=e;){if(e.hasNext())for(var d=e.next();null!=d;){if(b.parent().children().length>1){d.$e().animate({top:d.pos("top")-200-20}),$.each(d.branch(),function(a,b){c.push(b.$e().animate({top:b.$e().pos("top")-200-20}))})}d=d.next()}e=e.parent()}return void 0!==a&&$.when.apply($,c).done(function(){a()}),this},this.render=function(){if(this.$e().exists())var a=this.$e();else var a=this.build$e();a.hide(),this.query().$tree().append(a);for(var b=this.parent();void 0!=b;){if(b.link(),b.hasNext())for(var c=b.next();null!=c;){if(this.parent().children().length>1){var d=c;c.$e().animate({top:c.pos("top")+200+20},function(){d.hasChildren()&&d.link()}),$.each(c.branch(),function(a,b){var c=b;b.$e().animate({top:b.$e().pos("top")+200+20},function(){c.hasChildren()&&c.link()})})}c=c.next()}b=b.parent()}return a.fadeIn(),this},this.unlink=function(){this.query().$tree().find('.node-link[data-id="'+this.id()+'"]').remove()},this.link=function(){var a=this,b=this.clsBranch().length,c=null;this.query().$tree().find('.node-link[data-id="'+this.id()+'"]').remove();var d=$('<canvas data-id="'+this.id()+'" class="node-link"></canvas>');d.hide(),d.attr("width",30),d.pos("top",a.pos("top")).pos("left",this.$e().pos("left")+270-20),1==b?c=200:b>1&&(c=200*b+20*(b-1)-220*(this.last().clsBranch().length>1?this.last().clsBranch().length-1:0)),d.attr("height",c),this.query().$tree().append(d);var e="#6B6C6B",f=5;if(d.drawLine({strokeStyle:e,strokeWidth:f,x1:0,y1:100,x2:30,y2:100}),this.children().length>1){d.drawLine({strokeStyle:e,strokeWidth:f,x1:15,y1:102.5,x2:15,y2:c-100+2.5});var g=0;$.each(this.children(),function(a,b){if(a>0){g+=b.previous().hasChildren()?b.previous().clsBranch().length:1;var c=200*g+10*(2*g)+100,h={strokeStyle:e,strokeWidth:f,x1:17.5,y1:c,x2:30,y2:c};d.drawLine(h)}})}d.show()},this.computeCriteria=function(a,b){var c=this,d=[];$.each(this.criteria(),function(a,b){d.push(b.toJSON())}),App.Server.Criterion.compute(d,function(b){$.each(c.criteria(),function(a,b){b.computed(!0)}),a(b)},function(a){b(a)})}}function Criterion(data){this.allowedProperties=["id","attribute","operator","operation","value","node","criteria","typeFunction","entiere","sequenceFile"],this.defaults={id:uid(),attribute:null,operator:null,operation:null,value:null,node:null,typeFunction:null,sequenceFile:null};for(key in data)if($.inArray(key,this.allowedProperties)>-1){var obj=data[key];this["_"+key]=obj}this._internalId=null,this._computed=!1,this.computed=function(a){return null!=a?(this._computed=a,this):this._computed},this.id=function(a){return null!=a?(this._id=a,this):this._id},this.internalId=function(a){return null!=a?(this._internalId=a,this):this._internalId},this.attribute=function(a){return null!=a?(this._attribute=a,this):this._attribute},this.operator=function(a){return null!=a?(this._operator=a,this):this._operator},this.typeFunction=function(a){return null!=a?(this._typeFunction=a,this):this._typeFunction},this.operation=function(a){return null!=a?(this._operation=a,this):this._operation},this.value=function(a){return null!=a?(this._value=a,this):this._value},this.entiere=function(a){return null!=a?(this._entiere=a,this):this._entiere},this.node=function(a){return null!=a?(this._node=a,this):this._node},this.dataOperators={equalsTo:{text:"est égal à",type:"comparaison",shortText:"=",value:"equalsTo",hasValue:!0,notAvailableTypes:[]},notEqualsTo:{text:"est différent de",type:"comparaison",shortText:"différent de",value:"notEqualsTo",hasValue:!0,notAvailableTypes:[]},greaterThan:{text:"est supérieur ou égal à",type:"comparaison",shortText:">=",value:"greaterThan",hasValue:!0,notAvailableTypes:["link","string","boolean"]},sGreaterThan:{text:"est strictement supérieur à",type:"comparaison",shortText:">",value:"sGreaterThan",hasValue:!0,notAvailableTypes:["link","string","boolean"]},lessThan:{text:"est inférieur ou égal à",type:"comparaison",shortText:"<=",value:"lessThan",hasValue:!0,notAvailableTypes:["link","string","boolean"]},sLessThan:{text:"est strictement inférieur à",type:"comparaison",shortText:"<",value:"sLessThan",hasValue:!0,notAvailableTypes:["link","string","boolean"]},isEmpty:{text:"n'est pas renseigné",type:"logic",shortText:"pas renseigné",value:"isEmpty",hasValue:!1,notAvailableTypes:[]},isNotEmpty:{text:"est renseigné",type:"logic",shortText:"renseigné",value:"isNotEmpty",hasValue:!1,notAvailableTypes:[]},contains:{text:"contient",type:"comparaison",shortText:"contient",value:"contains",hasValue:!0,notAvailableTypes:["link","boolean","integer"]},beginsWith:{text:"commence par",type:"comparaison",shortText:"commence par",value:"beginsWith",hasValue:!0,notAvailableTypes:["link","boolean","integer"]},endsWith:{text:"se termine par",type:"comparaison",shortText:"se termine par",value:"endsWith",hasValue:!0,notAvailableTypes:["link","boolean","integer"]},between:{text:"est compris entre",type:"interval",shortText:"compris entre",value:"between",hasValue:!0,notAvailableTypes:["boolean"]},notBetween:{text:"n'est pas compris entre",type:"interval",shortText:"pas compris entre",value:"notBetween",hasValue:!0,notAvailableTypes:["boolean"]},"in":{text:"est compris dans",type:"sequence",shortText:"compris dans",value:"in",hasValue:!0,notAvailableTypes:["boolean"]},notIn:{text:"n'est pas compris dans",type:"sequence",shortText:"pas compris dans",value:"notIn",hasValue:!0,notAvailableTypes:["boolean"]}},this.operators=function(){var a=this,b=[];return $.each(this.dataOperators,function(c,d){-1==$.inArray(void 0==a.attribute().dataType()?a.attribute().type():a.attribute().dataType(),d.notAvailableTypes)&&b.push({value:d.value,text:d.text})}),b},this.dataOperations={exists:{text:"Aucune",shortText:"Aucune",value:"exists"},sum:{text:"Somme / Total",shortText:"Somme",value:"sum"},average:{text:"Moyenne",shortText:"Moyenne",value:"average"},standartDeviation:{text:"Ecart-type",shortText:"Ecart-type",value:"standartDeviation"},minimal:{text:"Valeur minimale",shortText:"Minimum",value:"minimum"},maximal:{text:"Valeur maximale",shortText:"Maximum",value:"maximum"},count:{text:"Nombre",shortText:"Nombre",value:"count"}},this.typeFunctions=function(a){var b=[];return this.hasTypeFunctions(a)&&$.each(this.dataTypeFunctions[a],function(a,c){b.push(c)}),b},this.hasTypeFunctions=function(a){return this.dataTypeFunctions.hasOwnProperty(a)},this.dataTypeFunctions={date:{dayOfWeek:{text:"Jour de la semaine",shortText:"Jour de la semaine",value:"dayOfWeek",returnType:"integer",formula:"dayOfWeek({0})",label:"Jour de la semaine de {0}"},dayOfMonth:{text:"Jour du mois",shortText:"Jour du mois",value:"dayOfMonth",returnType:"integer",formula:"dayOfMonth({0})",label:"Jour du mois de {0}"},dayOfYear:{text:"Jour de l'année",shortText:"Jour de l'année",value:"dayOfYear",returnType:"integer",formula:"dayOfYear({0})",label:"Jour de l'année de {0}"},weekOfYear:{text:"Semaine de l'année",shortText:"Semaine de l'année",value:"weekOfYear",returnType:"integer",formula:"weekOfYear({0})",label:"Semaine de l'année de {0}"},monthOfYear:{text:"Mois de l'année",shortText:"Mois de l'année",value:"monthOfYear",returnType:"integer",formula:"monthOfYear({0})",label:"Mois de l'année de {0}"},year:{text:"Année",shortText:"Année",value:"year",returnType:"integer",formula:"year({0})",label:"Année de {0}"},ageInDay:{text:"Age en jours",shortText:"Age en jours",value:"ageInDay",returnType:"integer",formula:"ageInDay({0})",label:"Age en jours de {0}"},ageInMonth:{text:"Age en mois",shortText:"Age en mois",value:"ageInMonth",returnType:"integer",formula:"ageInMonth({0})",label:"Age en mois de {0}"},ageInYear:{text:"Age en années",shortText:"Age en années",value:"ageInYear",returnType:"integer",formula:"ageInYear({0})",label:"Age en année de {0}"}}},this.operations=function(){var a=[];return $.each(this.dataOperations,function(b,c){a.push({value:c.value,text:c.text})}),a},this.$inite=function(){var a,b=this;if("readOnly"!=App.session.mode()){var c=$('<button class="criterion-remove"><i class="icon-close"></i></button>');c.hide().click(function(){b.$e().off("click"),App.Controller.Criterion["delete"](b)})}return a=$('<div class="criterion" data-id="'+this.id()+'">'+this.toString()+"</div>"),"readOnly"!=App.session.mode()&&(a.click(function(){App.Controller.Criterion.edit(b)}),a.append(c),a.hover(function(){a.addClass("criterion-hover"),c.show()},function(){a.removeClass("criterion-hover"),c.hide()})),a},this.$e=function(){if($('.criterion[data-id="'+this.id()+'"]').exists())var a=$('.criterion[data-id="'+this.id()+'"]');else var a=this.$inite();return a},this.remove=function(){return this.$e().fadeOut("slow"),this},this.render=function(){this.node().$e().find(".node-criteria").append(this.$e())},this.updateRender=function(){this.$e().replaceWith(this.$inite())},this.toJSON=function(){return{id:this.id(),path:this.attribute().path(),computed:this.computed(),operator:this.operator().name(),typeFunction:null!=this.typeFunction()?this.typeFunction().name():null,operation:void 0!=this.operation()?this.operation().name():null,value:null!=this.value()?this.value():null,node:this.node().id(),entiere:this.entiere(),sequenceFile:this.sequenceFile}},this.toString=function(){var that=this,str=void 0!=this.operation()&&"exists"!=this.operation().name()?this.operation().text+" de ":"";if(this.entiere())str+="Toute la base";else{var attribute=App.DataModel.attribute(this.attribute().path());str+=null!=this.typeFunction()?this.typeFunction().label.format(attribute.label())+" ":attribute.label()+" "}if(this.entiere()||(str+=this.operator().text+" "),void 0!=this.value())if("link"==this.attribute().type())if("sequence"==this.operator().type())if(this.sequenceFile)str+=" le fichier '"+this.sequenceFile.name+"'";else{var values=this.value().split(",");$.each(values,function(a,b){b=b.replace(new RegExp("'","gi"),""),str+=App.DataModel.referential(that.attribute().schema()).row(b).t,a==values.length-2?str+=" et ":a<values.length-1&&(str+=", ")})}else if("interval"==this.operator().type()){var values=this.value().split("-");
$.each(values,function(a,b){1==a&&(str+=" et "),str+=App.DataModel.referential(that.attribute().schema()).row(b).t})}else str+=App.DataModel.referential(that.attribute().schema()).row(that.value()).t;else{var enumLabel=function(a){return $.grep(that.attribute()._enum,function(b,c){return b.value==a})[0].label};if("interval"==this.operator().type()){var value1=this.value().split("-")[0],value2=this.value().split("-")[1];str+="date"==this.attribute().dataType()?$.format.date(new Date(value1.substr(0,4),parseInt(value1.substr(4,2))-1,value1.substr(6,2)),"dd/MM/yyyy")+" et "+$.format.date(new Date(value2.substr(0,4),parseInt(value2.substr(4,2))-1,value2.substr(6,2)),"dd/MM/yyyy"):this.attribute()._enum?enumLabel(value1)+" et "+enumLabel(value2):value1+" et "+value2}else if("sequence"==this.operator().type())if(this.sequenceFile)str+=" le fichier '"+this.sequenceFile.name+"'";else{var values=this.value().split(",");$.each(values,function(i,value){"date"==that.attribute().dataType()?(value=value.replace(new RegExp("'","gi"),""),value2=$.format.date(new Date(value.substr(0,4),parseInt(value.substr(4,2))-1,value.substr(6,2)),"dd/MM/yyyy"),str+=value2.replace(new RegExp("'","gi"),"")):str+=that.attribute()._enum?enumLabel(eval(value)):value,i==values.length-2?str+=" et ":i<values.length-1&&(str+=", ")})}else if(this.attribute()._enum)str+=enumLabel(this.value());else switch(this.attribute().dataType()){case"boolean":str+=1==this.value()?"Oui":"Non";break;case"date":str+=$.format.date(new Date(this.value().substr(0,4),parseInt(this.value().substr(4,2))-1,this.value().substr(6,2)),"dd/MM/yyyy");break;default:str+=this.value()}}return str},this.dialog=function(a,b){function c(a){if(f="interval"==g.operator().type()?new CriterionIntervalInput(g.inputValue()):"sequence"==g.operator().type()?new CriterionSequenceInput(g.inputValue()):g.inputValue(),a===!0){var b=g.value();g.sequenceFile&&(b={file:g.sequenceFile}),f.value(b)}var c=f.$input();h.append(c.$wrap),c.$input&&(c.$input.on("file:loading",function(){j.enableValid(!1)}),c.$input.on("file:loaded",function(){j.enableValid(!0)}))}function d(a){$.each(a,function(a,b){h.find(".criterion-"+b+"-wrap").remove(),g["_"+b]=null})}var e,f,g=this,h=$('<div class="criterion-form pn-form"></div>'),i=this.$inputAttribute(function(){d(["operation","typeFunction","operator","value"]),g.hasTypeFunctions(g.attribute().dataType())?h.append(g.$inputTypeFunction(g.attribute().dataType(),function(){d(["operation","operator","value"]),"multiple"!=g.attribute().linkCardinality()||"float"!=g.attribute().dataType()&&"integer"!=g.attribute().dataType()||h.append(g.$inputOperation("multiple",function(){})),"entiere"!=g.attribute().name()?h.append(g.$inputOperator(function(){d(["value"]),g.operator().hasValue&&c()})):g.operator(new Operator("isNotEmpty"))})):("multiple"!=g.attribute().linkCardinality()||"float"!=g.attribute().dataType()&&"integer"!=g.attribute().dataType()||h.append(g.$inputOperation("multiple",function(){})),g.entiere()?g.operator(new Operator("isNotEmpty")):h.append(g.$inputOperator(function(){d(["value"]),g.operator().hasValue&&c()})))});h.append(i),b&&(g.entiere()?g.operator(new Operator("isNotEmpty")):null!=g.typeFunction()?(h.append(g.$inputTypeFunction(g.typeFunction().type(),function(){d(["operation","operator","value"]),null!=g.operation()&&("multiple"!=g.attribute().linkCardinality()||"float"!=g.attribute().dataType()&&"integer"!=g.attribute().dataType()||h.append(g.$inputOperation("multiple",function(){c()}))),h.append(g.$inputOperator(function(){d(["value"]),g.operator().hasValue&&c()}))})),null!=g.operation()&&("multiple"!=g.attribute().linkCardinality()||"float"!=g.attribute().dataType()&&"integer"!=g.attribute().dataType()||h.append(g.$inputOperation("multiple",function(){d(["value"]),c()}))),h.append(g.$inputOperator(function(){d(["value"]),g.operator().hasValue&&c()})),g.operator().hasValue&&c(!0)):(null!=g.operation()&&("multiple"!=g.attribute().linkCardinality()||"float"!=g.attribute().dataType()&&"integer"!=g.attribute().dataType()||h.append(g.$inputOperation("multiple",function(){d(["value"]),c()}))),h.append(g.$inputOperator(function(){d(["value"]),g.operator().hasValue&&c()})),g.operator().hasValue&&c(!0))),e=b?"Critère '"+this.toString()+"'":"Nouveau critère";var j=new UI.Dialog(e,h,{width:1e3},function(){g.operator().hasValue?(f.file&&(g.sequenceFile=f.file),g.value(f.value())):g._value=null,j.close(),a()});return j},this.$inputAttribute=function(a){var b=this,c=$('<span class="criterion-attribute-wrap pn-form-wrap pn-form-search-wrap"></span>'),d=$('<button class="k-button"><i class="icon-search"/></button>'),e=$('<span class="criterion-attribute-input">'+(null==this.attribute()?"Sélectionner une variable":this.entiere()?"Toute la base":this.attribute().label())+"</span>");return d.click(function(){var c=App.DataModel.dialog("Sélectionner la variable",function(d){("attribute"==d.type()||"link"==d.type()&&"multiple"!=d.linkCardinality())&&(b.attribute(d),"entiere"==d.dataType()?(b.entiere(!0),e.text("Toute la base")):(b.entiere(!1),e.text(d.label())),a(),c.close())},{hideQueryAttrs:!0})}),c.append(d).append(e),c},this.$inputOperator=function(a){var b=this,c=$('<span class="criterion-operator-wrap pn-form-wrap"></span>'),d=$('<input class="criterion-operator-input"/>');return c.append(d),d.kendoDropDownList({dataTextField:"text",dataValueField:"value",dataSource:b.operators(),optionLabel:"Opérateur...",select:function(c){b.operator(new Operator(this.dataItem(c.item.index()).value)),a()}}),null!=this.operator()&&d.data("kendoDropDownList").value(this.operator().name()),c},this.$inputTypeFunction=function(a,b){var c=this,d=$('<span class="criterion-typeFunction-wrap pn-form-wrap"></span>'),e=$('<input class="criterion-typeFunction-input"/>');d.append(e);var f=c.typeFunctions(a);return f.unshift({text:"Aucune",value:"none"}),e.kendoComboBox({dataTextField:"text",dataValueField:"value",dataSource:f,filter:"contains",placeholder:"Fonction...",select:function(d){"none"!=this.dataItem(d.item.index()).value&&(c.typeFunction(new TypeFunction(a,this.dataItem(d.item.index()).value)),c.attribute().dataType(c.typeFunction().returnType)),b()}}),null!=this.typeFunction()&&e.data("kendoComboBox").value(this.typeFunction().name()),d},this.$inputOperation=function(a,b){var c=this,d=$('<span class="criterion-operation-wrap pn-form-wrap"></span>'),e=$('<input class="criterion-operation-input"/>');return d.append(e),e.kendoComboBox({dataTextField:"text",dataValueField:"value",dataSource:c.operations(),filter:"contains",placeholder:"Opérations...",select:function(a){c.operation(new Operation(this.dataItem(a.item.index()).value)),b()}}),null!=this.operation()&&e.data("kendoComboBox").value(this.operation().name()),d},this.inputValue=function(){var a,b=this;if(console.log(b.attribute()),b.attribute()._enum&&b.attribute()._enum.length)a=new CriterionEnumInput({"enum":b.attribute()._enum});else switch(b.attribute().dataType()){case"integer":a=new CriterionNumberInput;break;case"float":a=new CriterionNumberInput({format:b.attribute().format(),type:b.attribute().dataType()});break;case"string":a=new CriterionStringInput;break;case"boolean":a=new CriterionBooleanInput;break;case"date":case"datetime":a=new CriterionDateInput;break;default:"link"==b.attribute().type()&&(a=b.attribute().hugeData()?new CriterionHugeDataLinkInput(b.attribute().schema(),b.attribute().keyName(),"sequence"==b.operator().type()):new CriterionLinkInput(b.attribute().schema(),b.attribute().keyName()))}return a},this.compute=function(a,b){var c=this;App.Server.Criterion.compute([this.toJSON()],function(b){c.computed(!0),a(b)},function(a){b(a)})}}function CriterionNumberInput(a){null==a&&(a={}),this._format=null!=a.format?a.format:null,this._type=null!=a.type?a.type:"integer",this._exists=!1,this._input={},this._availableOperators=["equalsTo","notEqualsTo","greaterThan","sGreaterThan","lessThan","sLessThan","isEmpty","isNotEmpty","between","notBetween","in","notIn"],this.value=function(a){return null==a?this.$input().$input.data("kendoNumericTextBox").value():void this.$input().$input.data("kendoNumericTextBox").value(a)},this.$input=function(){if(this._exists)return this._input;this._exists=!0;var a=$('<span class="criterion-value-wrap pn-form-wrap"></span>'),b=$('<input class="criterion-value-input"/>');return a.append(b),b=this.init(b),this._input={$wrap:a,$input:b},this._input},this.init=function(b){if("float"==this._type)switch(this._format){case"percent":a={format:"p0",min:0,max:1,step:.01};break;case"amount":a={format:"#.00 €"}}else"integer"==this._type&&(a={decimal:0,step:1});return b.kendoNumericTextBox(a),b},this.validation=function(){return""!=this.value()}}function CriterionStringInput(){this._exists=!1,this._input={},this._availableOperators=["equalsTo","notEqualsTo","isEmpty","isNotEmpty","beginsWith","endsWith","contains"],this.value=function(a){return null==a?this.$input().$input.val():void this.$input().$input.val(a)},this.$input=function(){if(this._exists)return this._input;this._exists=!0;var a=$('<span class="criterion-value-wrap pn-form-wrap"></span>'),b=$('<input class="k-textbox criterion-value-input"/>');return a.append(b),b=this.init(b),this._input={$wrap:a,$input:b},this._input},this.init=function(a){return a},this.validation=function(){return""!=this.value()}}function CriterionBooleanInput(){this._exists=!1,this._input={},this._availableOperators=["equalsTo","notEqualsTo","isEmpty","isNotEmpty"],this.value=function(a){return null==a?this.$input().$input.data("kendoComboBox").value():void this.$input().$input.data("kendoComboBox").value(a)},this.$input=function(a){if(this._exists)return this._input;this._exists=!0;var a=$('<span class="criterion-value-wrap pn-form-wrap"></span>'),b=$('<input class="criterion-value-input" data-id="'+this._uid+'"/>');return a.append(b),a.append(b),b=this.init(b),this._input={$wrap:a,$input:b},this._input},this.init=function(a){return a.kendoComboBox({dataTextField:"text",dataValueField:"value",dataSource:[{text:"oui",value:"1"},{text:"non",value:"0"}],criterion:"contains",placeholder:"Valeur...",suggest:!0}),a},this.validation=function(){return""!=this.value()}}function CriterionDateInput(){this._exists=!1,this._input={},this._availableOperators=["equalsTo","notEqualsTo","greaterThan","sGreaterThan","lessThan","sLessThan","isEmpty","isNotEmpty","between","notBetween","in","notIn"],this.value=function(a){if(null==a)return $.format.date(this.$input().$input.data("kendoDatePicker").value(),"yyyyMMdd");var b=new Date(a.substr(0,4),a.substr(4,2),a.substr(6,2));this.$input().$input.data("kendoDatePicker").value(b)},this.$input=function(){if(this._exists)return this._input;this._exists=!0;var a=$('<span class="criterion-value-wrap pn-form-wrap"></span>'),b=$('<input class="criterion-value-input"/>');return a.append(b),b=this.init(b),this._input={$wrap:a,$input:b},this._input},this.init=function(a){return a.kendoDatePicker({format:"dd/MM/yyyy",culture:"fr-FR"}),a},this.validation=function(){return""!=this.value()}}function CriterionLinkInput(a,b){this._schema=a,this._key=b,this._sequenced=!1,this._exists=!1,this._input={},this._availableOperators=["equalsTo","notEqualsTo","isEmpty","isNotEmpty"],this._dataItem=null,this.value=function(a){return null==a?this._sequenced?this.$input().$input.data("kendoMultiSelect").value().join(","):void 0==this._dataItem?this.$input().$input.data("kendoComboBox").dataItem().v:this._dataItem.v:void this.$input().$input.data(this._sequenced?"kendoMultiSelect":"kendoComboBox").value(a)},this.$input=function(){if(this._exists)return this._input;this._exists=!0;var a=$('<span class="criterion-value-wrap pn-form-wrap"></span>'),b=$('<input class="criterion-value-input"/>');return a.append(b),b=this.init(b),this._input={$wrap:a,$input:b},this._input},this.init=function(a,b){var c=this;null!=b&&(this._sequenced=b);var d=App.DataModel.referential(this._schema).data(),e={dataSource:d,dataTextField:"t",dataValueField:"v",autoBind:!0,filter:"contains",placeholder:"Valeur...",suggest:!1,select:function(a){c._dataItem=this.dataItem(a.item.index())}};return this._sequenced?a.kendoMultiSelect(e):a.kendoComboBox(e),a},this.validation=function(){return""!=this.value()}}function CriterionHugeDataLinkInput(a,b,c){this._schema=a,this._key=b,this._sequenced=c,this._exists=!1,this._input={},this._availableOperators=["equalsTo","notEqualsTo","isEmpty","isNotEmpty"],this._dataItem=null,this.value=function(a){var b=this;if(null==a)return this.$input().$input.data("kendoMultiSelect").value()[0];var c=a.replace(new RegExp("'","gi"),"").split(","),d=[];$.each(c,function(a,c){d.push(App.DataModel.referential(b._schema).row(c))}),this.$input().$input.data("kendoMultiSelect").setDataSource(d),this.$input().$input.data("kendoMultiSelect").value(c)},this.$input=function(){if(this._exists)return this._input;this._exists=!0;var a=$('<span class="criterion-value-wrap pn-form-wrap"></span>'),b=$('<button class="k-button">Ajouter</button>');b.css("marginTop","-15px"),b.click(function(){var a=d.data("kendoGrid"),b=c.data("kendoMultiSelect").dataItems(),e=[];$.each(b,function(a,b){e.push({v:b.v,t:b.t})}),$.each(a.select(),function(b,c){e.push({v:a.dataItem(a.select()[b]).v,t:a.dataItem(a.select()[b]).t})});var f=[];$.each(e,function(a,b){f.push(b.v)}),c.data("kendoMultiSelect").setDataSource(e),c.data("kendoMultiSelect").value(f)}),a.append(b);var c=$('<div class="criterion-value-input"></div>');c.css("margin","10px"),a.append(c),c=this.init(c);var d=$("<div></div>");return a.append(d),d=this.list(d),this._input={$wrap:a,$input:c},this._input},this.init=function(a){var b=this,c={dataTextField:"t",dataValueField:"v",autoBind:!0,filter:"contains",placeholder:"Valeur...",suggest:!1,maxSelectedItems:b._sequenced?null:1};return a.kendoMultiSelect(c),a},this.list=function(a){var b={dataSource:{data:App.DataModel.referential(this._schema).data(),pageSize:8},sortable:!0,selectable:this._sequenced?"multiple, row":!0,navigatable:!0,filterable:{and:"et",or:"ou",filter:"Appliquer",clear:"RAZ",info:"Filtrer par : ",isFalse:"Non",isTrue:"Oui",selectValue:"Sélectionner"},pageable:{messages:{display:"{0} - {1} de {2} éléments",empty:"Aucun élément",page:"Page",of:"de {0}",itemsPerPage:"éléments par page",first:"Première page",previous:"Page précédente",next:"Page suivante",last:"Dernière page"}},columns:[{field:"t",title:"Libellé",width:120}],columnMenu:{messages:{refresh:"Rafraîchir",columns:"Choisir les colonnes",filter:"Appliquer",sortAscending:"Trier A-Z",sortDescending:"Trier Z-A"}}};return a.kendoGrid(b),a}}function CriterionIntervalInput(a){this._criterionInput=a,this._exists=!1,this._input={},this.value=function(a){return null==a?this.$input().input1.value()+"-"+this.$input().input2.value():(this.$input().input1.value(a.split("-")[0]),void this.$input().input2.value(a.split("-")[1]))},this.$input=function(){if(this._exists)return this._input;this._exists=!0;var b=$('<span class="criterion-value-wrap pn-form-wrap"></span>'),c=a.clone?a.clone():clone(a),d=a.clone?a.clone():clone(a),e=c.$input().$input,f=d.$input().$input;return b.append(c.$input().$input),b.append(" et "),b.append(d.$input().$input),e=c.init(e),f=d.init(f),this._input={$wrap:b,input1:c,input2:d},this._input}}function CriterionSequenceInput(a){this._criterionInput=a,this._exists=!1,this._input={},this.value=function(a){var b=this;if(null==a){if("CriterionLinkInput"==this._criterionInput.constructor.name||"CriterionHugeDataLinkInput"==this._criterionInput.constructor.name)var c=this.$input().$input.data("kendoMultiSelect").value();else if("CriterionDateInput"===this._criterionInput.constructor.name){var c=[];$.each(this.$input().$input.val().split(","),function(a,b){c.push($.format.date(new Date(b.substr(6,4),b.substr(3,2),b.substr(0,2)),"yyyyMMdd"))})}else var c=this.$input().$input.val().split(",");var d=[];return $.each(c,function(a,b){d.push("'"+b+"'")}),d.join(",")}if("CriterionLinkInput"==this._criterionInput.constructor.name){var c=a.replace(new RegExp("'","gi"),"").split(",");this.$input().$input.data("kendoMultiSelect").value(c)}else if("CriterionHugeDataLinkInput"==this._criterionInput.constructor.name){var c=a.replace(new RegExp("'","gi"),"").split(","),e=[];$.each(c,function(a,c){e.push(App.DataModel.referential(b._criterionInput._schema).row(c))}),this.$input().$input.data("kendoMultiSelect").setDataSource(e),this.$input().$input.data("kendoMultiSelect").value(c)}else if("CriterionDateInput"===this._criterionInput.constructor.name){var c=[];$.each(a.split(","),function(a,b){b=b.replace(new RegExp("'","gi"),""),c.push($.format.date(new Date(b.substr(0,4),b.substr(4,2),b.substr(6,2)),"dd/MM/yyyy"))}),this.$input().$input.val(c.join(","))}else a.file?b.fileMode(a.file.name):this.$input().$input.val(a.replace(new RegExp("'","gi"),""))},this.fileMode=function(a){var b=this.$input().$wrap;b.find(".criterion-value-wrap").hide(),b.find(".criterion-sequence-add").hide(),b.find(".criterion-sequence-value").hide(),b.find(".criterion-value-input").hide(),b.find(".criterion-sequence-file").show().val(a)},this.$input=function(){var b=this;if(this._exists)return this._input;this._exists=!0;var c=$('<span class="criterion-value-wrap pn-form-wrap"></span>');if("CriterionLinkInput"==this._criterionInput.constructor.name){var d=clone(a),e=d.$input().$input;c.append(e),e=d.init(e,"sequence")}else if("CriterionHugeDataLinkInput"==this._criterionInput.constructor.name){var e=a.$input().$input;c.append(a.$input().$wrap)}else{var f=$('<button class="k-button criterion-sequence-add"><i class="icon-plus" title="Ajouter une valeur"/></button>'),e=$("<textarea>",{"class":"k-textbox criterion-sequence-value",cols:70,rows:5}),g=a.clone?a.clone():clone(a),h=g.$input().$input;c.append(h),c.append(f),c.append(e),h=g.init(h),f.click(function(){""!==h.val()&&(e.text(e.text()+(""!==e.text()?",":"")+h.val()),h.val("")),h.focus()});var i=$("<button>",{"class":"k-button",html:"<i class='icon-download-3'></i> Importer une liste"}).appendTo(c),j=$("<input>",{disabled:!0,"class":"criterion-sequence-file k-textbox"}).appendTo(c).hide();i.on("click",function(){k.trigger("click")}).appendTo(c);var k=$("<input>",{"class":"criteria-sequence-file-input",type:"file",accept:".txt, .csv"}).appendTo(c);k.on("change",function(){var a=new FormData,c=k[0].files[0];a.append("file",c),b.fileMode(c.name),j.val("Téléchargement..."),i.hide(),e.trigger("file:loading"),App.Server.Criterion.file(a).done(function(a){j.val(c.name),i.show(),a.name=c.name,b.file=a,e.trigger("file:loaded")})})}return this._input={$wrap:c,$input:e},this._input}}function CriterionEnumInput(a){null==a&&(a={}),this["enum"]=a["enum"],this._exists=!1,this._input={},this._availableOperators=["equalsTo","notEqualsTo","greaterThan","sGreaterThan","lessThan","sLessThan","isEmpty","isNotEmpty","between","notBetween","in","notIn"],this.value=function(a){return null==a?this.$input().$input.data("kendoDropDownList").value():void this.$input().$input.data("kendoDropDownList").value(a)},this.$input=function(){if(this._exists)return this._input;this._exists=!0;var a=$('<span class="criterion-value-wrap pn-form-wrap"></span>'),b=$('<input class="criterion-value-input"/>');return a.append(b),b=this.init(b),this._input={$wrap:a,$input:b},this._input},this.init=function(a){return a.kendoDropDownList({dataSource:this["enum"],dataValueField:"value",dataTextField:"label"}),a},this.validation=function(){return""!=this.value()},this.clone=function(){if("object"!=typeof this||null==this)return this;var a=new this.constructor;return a["enum"]=[],$.each(this["enum"],function(b,c){a["enum"].push({value:c.value,label:c.label})}),a}}function Operator(a){this._name=a,this.dataOperators={equalsTo:{text:"est égal à",type:"comparaison",shortText:"=",value:"equalsTo",hasValue:!0,notAvailableTypes:[]},notEqualsTo:{text:"est différent de",type:"comparaison",shortText:"différent de",value:"notEqualsTo",hasValue:!0,notAvailableTypes:[]},greaterThan:{text:"est supérieur ou égal à",type:"comparaison",shortText:">=",value:"greaterThan",hasValue:!0,notAvailableTypes:["link","string","boolean"]},sGreaterThan:{text:"est strictement supérieur à",type:"comparaison",shortText:">",value:"sGreaterThan",hasValue:!0,notAvailableTypes:["link","string","boolean"]},lessThan:{text:"est inférieur à",type:"comparaison",shortText:"<=",value:"lessThan",hasValue:!0,notAvailableTypes:["link","string","boolean"]},sLessThan:{text:"est strictement inférieur à",type:"comparaison",shortText:"<",value:"sLessThan",hasValue:!0,notAvailableTypes:["link","string","boolean"]},isEmpty:{text:"n'est pas renseigné",type:"logic",shortText:"pas renseigné",value:"isEmpty",hasValue:!1,notAvailableTypes:[]},isNotEmpty:{text:"est renseigné",type:"logic",shortText:"renseigné",value:"isNotEmpty",hasValue:!1,notAvailableTypes:[]},contains:{text:"contient",type:"comparaison",shortText:"contient",value:"contains",hasValue:!0,notAvailableTypes:["link","boolean","integer"]},beginsWith:{text:"commence par",type:"comparaison",shortText:"commence par",value:"beginsWith",hasValue:!0,notAvailableTypes:["link","boolean","integer"]},endsWith:{text:"se termine par",type:"comparaison",shortText:"se termine par",value:"endsWith",hasValue:!0,notAvailableTypes:["link","boolean","integer"]},between:{text:"est compris entre",type:"interval",shortText:"compris entre",value:"between",hasValue:!0,notAvailableTypes:["boolean"]},notBetween:{text:"n'est pas compris entre",type:"interval",shortText:"pas compris entre",value:"notBetween",hasValue:!0,notAvailableTypes:["boolean"]},"in":{text:"est compris dans",type:"sequence",shortText:"compris dans",value:"in",hasValue:!0,notAvailableTypes:["boolean"]},notIn:{text:"n'est pas compris dans",type:"sequence",shortText:"pas compris dans",value:"notIn",hasValue:!0,notAvailableTypes:["boolean"]}},this.text=this.dataOperators[this._name].text,this.shortText=this.dataOperators[this._name].shorText,this.hasValue=this.dataOperators[this._name].hasValue,this.type=function(){return this.dataOperators[this._name].type},this.notAvailableTypes=this.dataOperators[this._name].notAvailableTypes,this.name=function(){return this._name}}function Operation(a){this._name=a,this.dataOperations={exists:{text:"Aucune",shortText:"Aucune",value:"exists"},sum:{text:"Somme / Total",shortText:"Somme",value:"sum"},average:{text:"Moyenne",shortText:"Moyenne",value:"average"},standartDeviation:{text:"Ecart-type",shortText:"Ecart-type",value:"standartDeviation"},minimal:{text:"Valeur minimale",shortText:"Minimum",value:"minimum"},maximal:{text:"Valeur maximale",shortText:"Maximum",value:"maximum"},count:{text:"Nombre",shortText:"Nombre",value:"count"}},this.text=this.dataOperations[this._name].text,this.shortText=this.dataOperations[this._name].shorText,this.name=function(){return this._name}}function Attribute(a){this.allowedProperties=["name","label","type","format","schema","path","dataType","linkCardinality","keyName","hugeData","enum","query"];for(key in a)if($.inArray(key,this.allowedProperties)>-1){var b=a[key];this["_"+key]=b}this.name=function(a){return null!=a?(this._name=a,this):this._name},this.label=function(a){return null!=a?(this._label=a,this):this._label},this.type=function(a){return null!=a?(this._type=a,this):this._type},this.format=function(a){return null!=a?(this._format=a,this):this._format},this.path=function(a){return null!=a?(this._path=a,this):this._path},this.dataType=function(a){return null!=a?(this._dataType=a,this):this._dataType},this.linkCardinality=function(a){return null!=a?(this._linkCardinality=a,this):this._linkCardinality},this.keyName=function(a){return null!=a?(this._keyName=a,this):this._keyName},this.schema=function(a){return null!=a?(this._schema=a,this):this._schema},this.hugeData=function(a){return null!=a?(this._hugeData=a,this):this._hugeData}}function TypeFunction(a,b){this._type=a,this._name=b,this.dataTypeFunctions={date:{dayOfWeek:{text:"Jour de la semaine",shortText:"Jour de la semaine",value:"dayOfWeek",returnType:"integer",formula:"dayOfWeek({0})",label:"Jour de la semaine de {0}"},dayOfMonth:{text:"Jour du mois",shortText:"Jour du mois",value:"dayOfMonth",returnType:"integer",formula:"dayOfMonth({0})",label:"Jour du mois de {0}"},dayOfYear:{text:"Jour de l'année",shortText:"Jour de l'année",value:"dayOfYear",returnType:"integer",formula:"dayOfYear({0})",label:"Jour de l'année de {0}"},weekOfYear:{text:"Semaine de l'année",shortText:"Semaine de l'année",value:"weekOfYear",returnType:"integer",formula:"weekOfYear({0})",label:"Semaine de l'année de {0}"},monthOfYear:{text:"Mois de l'année",shortText:"Mois de l'année",value:"monthOfYear",returnType:"integer",formula:"monthOfYear({0})",label:"Mois de l'année de {0}"},ageInDay:{text:"Age en jours",shortText:"Age en jours",value:"ageInDay",returnType:"integer",formula:"ageInDay({0})",label:"Age en jours de {0}"},ageInMonth:{text:"Age en mois",shortText:"Age en mois",value:"ageInMonth",returnType:"integer",formula:"ageInMonth({0})",label:"Age en mois de {0}"},ageInYear:{text:"Age en années",shortText:"Age en années",value:"ageInYear",returnType:"integer",formula:"ageInYear({0})",label:"Age en année de {0}"},year:{text:"Année",shortText:"Année",value:"year",returnType:"integer",formula:"year({0})",label:"Année de {0}"}}},this.text=this.dataTypeFunctions[this._type][this._name].text,this.shortText=this.dataTypeFunctions[this._type][this._name].shorText,this.value=this.dataTypeFunctions[this._type][this._name].value,this.returnType=this.dataTypeFunctions[this._type][this._name].returnType,this.formula=this.dataTypeFunctions[this._type][this._name].formula,this.label=this.dataTypeFunctions[this._type][this._name].label,this.name=function(){return this._name},this.type=function(){return this._type}}$.fn.exists=function(){return this.length>0},$.fn.pos=function(a,b){return this.exists()?null==b?parseInt($(this).css(a).toString().replace("px","")):($(this).css(a,parseInt(b)+"px"),this):this},Object.size=function(a){var b,c=0;for(b in a)a.hasOwnProperty(b)&&c++;return c},String.prototype.format=function(){var a=arguments;return this.replace(/{(\d+)}/g,function(b,c){return"undefined"!=typeof a[c]?a[c]:b})},Array.prototype.unset=function(a){for(var b=this.slice(0,a),c=a+1;c<this.length;c++)b.push(this[c]);return b},Array.prototype.insert=function(a,b){var c=this.slice(0,a+1);return c.push(b),c.concat(this.slice(a+1,this.length))};var UI=function(){};UI.Dialog=function(a,b,c,d,e){this._defaultOptions={width:500,actions:["Close"],commands:{valid:{text:"OK",icon:"checkmark",enabled:!0,display:!0},cancel:{text:"Annuler",icon:"undo",enabled:!0,display:!0}}};var f=this;this._defaultOnCancel=function(){this.k().close()},this._title=a,this._$content=b,this._onValid=void 0==d?function(){}:d,this._onCancel=function(){void 0!=e&&e(),f._defaultOnCancel()},this._options=void 0==c?this._defaultOptions:c,this.getDefaultOption=function(a){return void 0==this._options[a]?this._defaultOptions[a]:c[a]},this._options.actions=this.getDefaultOption("actions"),this._options.width=this.getDefaultOption("width"),this._options.commands=this.getDefaultOption("commands"),this.getCommandDefaultOption=function(a,b){return null==b?void 0==this._options.commands[a]?this._defaultOptions.commands[a]:this._options.commands[a]:void 0==this._options.commands[a][b]?this._defaultOptions.commands[a][b]:this._options.commands[a][b]},this._options.commands.valid=this.getCommandDefaultOption("valid"),this._options.commands.valid.text=this.getCommandDefaultOption("valid","text"),this._options.commands.valid.icon=this.getCommandDefaultOption("valid","icon"),this._options.commands.valid.enabled=this.getCommandDefaultOption("valid","enabled"),this._options.commands.valid.display=this.getCommandDefaultOption("valid","display"),this._options.commands.cancel=this.getCommandDefaultOption("cancel"),this._options.commands.cancel.text=this.getCommandDefaultOption("cancel","text"),this._options.commands.cancel.icon=this.getCommandDefaultOption("cancel","icon"),this._options.commands.cancel.enabled=this.getCommandDefaultOption("cancel","enabled"),this._options.commands.cancel.display=this.getCommandDefaultOption("cancel","display"),this.$initValid=function(a,b){return $('<button id="pn-dialog-valid" class="k-button pn-button-valid"><i class="icon-'+b+'"></i> '+a+"</button>")},this.$initCancel=function(a,b){return $('<button id="pn-dialog-cancel" class="k-button pn-button-cancel"><i class="icon-'+b+'"></i> '+a+"</button>")},this._$e=$('<div class="pn-dialog"></div>');var b=$('<div class="pn-dialog-content"></div>');b.append(this._$content);var g=$('<div class="pn-dialog-commands"></div>'),h=this.$initValid(this._options.commands.valid.text,this._options.commands.valid.icon);h.click(this._onValid);var i=this.$initCancel(this._options.commands.cancel.text,this._options.commands.cancel.icon);i.click(this._onCancel),g.append(h).append(i),this._$e.append(b).append(g),this._$e.kendoWindow({width:this._options.width+"px",title:this._title,visible:!1,modal:!0,close:function(){f.$e().parent().remove()},actions:this._options.actions}).data("kendoWindow").center(),this.$e=function(){return this._$e},this.k=function(){return this.$e().data("kendoWindow")},this.open=function(){this.k().open()},this.close=function(){this.k().close()},this.title=function(a){return null!=a?(this._title=a,this.k().title(a),this):this._title},this.$content=function(){return this.$e().children(".pn-dialog-content")},this.$commands=function(){return this.$e().children(".pn-dialog-commands")},this.$valid=function(){return this.$commands().children("#pn-dialog-valid")},this.$cancel=function(){return this.$commands().children("#pn-dialog-cancel")},this.enableButton=function(a,b){b?a.removeAttr("disabled").removeClass("k-state-disabled"):a.attr("disabled","disabled").addClass("k-state-disabled")},this.enableValid=function(a){this.enableButton(this.$valid(),a)},this.enableCancel=function(a){this.enableButton(this.$cancel(),a)},this.displayButton=function(a,b){a.css("display",b?"inline-block":"none")},this.displayValid=function(a){this.displayButton(this.$valid(),a)},this.displayCancel=function(a){this.displayButton(this.$cancel(),a)},this.onValid=function(a){this._onValid=a,this.$valid().click(a)},this.onCancel=function(a){this._onCancel=a,this.$cancel().click(a)},this.displayValid(this._options.commands.valid.display),this.displayCancel(this._options.commands.cancel.display),this.enableValid(this._options.commands.valid.enabled),this.enableCancel(this._options.commands.cancel.enabled),this.valid=function(a){var b=this.$initValid(a.text,a.icon);this.$valid().replaceWith(b)},this.cancel=function(a){var b=this.$initCancel(a.text,a.icon);this.$cancel().replaceWith(b),b.click(this._onCancel)}},UI.Confirm=function(a,b,c){var d=new UI.Dialog("Confirmation",$('<div class="pn-confirm-message">'+a+"</div>"),{commands:{valid:{text:"Oui"},cancel:{text:"Non"}}});return d.onValid(function(){b(),d.close()}),d.onCancel(function(){(c||function(){})()}),d},UI.Alert=function(a,b){var c=new UI.Dialog(b||"Alerte",$('<div class="pn-confirm-message">'+a+"</div>"),{commands:{cancel:{display:!1},valid:{text:"OK"}}});return c.onValid(function(){c.close()}),c};var App=function(){};App.version="0.1",App.settings={},App.config={server:{}},App.loadSettings=function(a){$.each(a,function(a,b){App.settings[a]={},$.each(b,function(b,c){App.settings[a][b]="true"==c?!0:"false"==c?!1:c})})},App.loadConfig=function(a){$.getJSON("config.json",function(b){App.config.server.url=b.server.url,App.config.server.port=b.server.port,a()})},App.login=function(a,b,c,d){App.Server.Auth.login(a,b,function(d){App.account={username:d.username,company:d.company,auth:{}},App.loadSettings(d.settings),b?App.account.auth.str=a:App.account.auth=a,App.account.auth.encrypted=b,c(d)},function(a){d(a)})},App.openAbout=function(){var a=$("<div>campPN version 0.10<br/>Version du serveur : 0.12<br/>Copyright PNdata&reg; SAS 2013. Tous droits réservés.</div>"),b=new UI.Dialog("A propos de camPN",a,{
width:400,commands:{valid:{text:"Fermer"},cancel:{display:!1}}},function(){b.close()});b.open()},App.css=function(a){$("head").find("link.pn-css").each(function(){$(this).remove()}),$("head").append('<link type="text/css" rel="stylesheet" class="pn-css" href="css/'+a+'.css"/>')},App.render=function(a,b){$("#"+a).load(a+".html",function(){b()})},App.start=function(){App.loadConfig(function(){function a(){void 0==App.account?($("body").addClass("login"),App.render("login",function(){})):App.render("app",function(){$("#login-button").text("Chargement..."),$("#account-username").text(App.account.username),$("#account-company").text(App.account.company.name),$("header").addClass("flex"),$("#content").addClass("flex"),App.DataModel.load(function(){App.DataModel.init(function(){App.Controller.Session["new"](""!=e?e:void 0,function(){App.UI.buildMenu(),App.UI.buildShortcuts(),$("#query-list").show().append('<li class="empty"><span class="query-label">Pas de requête</span></li>'),App.UI.state().synch.ready(),$("#query-list").sortable({placeholder:"query-item-drag",items:"> li:not(.query-item-excl)",cursor:"move",update:function(a,b){var c=b.item.attr("data-id"),d=App.session.query(c),e=d.next(),f=App.session.queries().indexOf(App.session.query(c)),g=[];$.each($("#query-list").children("li").not("join"),function(a,b){null!=App.session.exclQuery()?App.session.exclQuery().id()!=$(b).attr("data-id")&&g.push(App.session.query($(b).attr("data-id"))):g.push(App.session.query($(b).attr("data-id")))}),App.session._queries=g;var h=App.session.queries().indexOf(App.session.query(c));if(App.session.computeOnTheFly()){var i=null;h>f?i=e:f>h&&(i=d),null!=i&&App.Controller.Query.computeFrom(i,function(){},function(){})}}}),App.UI.loaded(),$("body").removeClass("login"),$("#login").fadeOut(),$("#app").fadeIn()})})})})}var b=$(location).attr("href"),c=(b.indexOf("?")>0?b.substr(b.indexOf("?")+1):"").replace("#","");if(""!=c){var d=c.split("."),e=d[0],f=d[1];App.login(f,!0,function(){a()},function(){})}else a()})},App.UI={loading:function(){$("body").append('<div id="app-loading">Chargement</div>')},loaded:function(){$("#app-loading").fadeOut("slow",function(){this.remove()}),$("#app").show()}},App.UI.node={save:{enabled:!0,icon:"upload-3",tooltip:"Enregistrer en tant que modèle"},load:{enabled:!0,icon:"download-3",tooltip:"Charger un modèle"},addCriterion:{enabled:!0,icon:"filter-2",tooltip:"Ajouter un critère"},remove:{enabled:!0,icon:"minus",tooltip:"Supprimer"},addNode:{enabled:!0,icon:"plus",tooltip:"Ajouter un niveau"}},App.UI.query={edit:{enabled:!0,excl:!0,icon:"pencil",tooltip:"Modifier",event:function(){App.Controller.Query.dialog(that)}},remove:{enabled:!0,excl:!0,icon:"minus",tooltip:"Supprimer",event:function(){App.Controller.Query.remove(that)}},load:{enabled:!0,excl:!0,icon:"download-3",tooltip:"Charger un modèle",event:function(){that.openDialogLoad()}},save:{enabled:!0,excl:!0,icon:"upload-3",tooltip:"Enregistrer en tant que modèle",event:function(){App.Controller.Query.openSaveModel(that)}}},App.UI.shortcuts=[{value:"save",text:"Enregistrer",icon:"disk",event:function(){App.Controller.Session.save()}},{value:"open",text:"Ouvrir",icon:"folder-open",event:function(){App.Controller.Session.open()}},{value:"new",text:"Nouveau",icon:"file-2",event:function(){App.Controller.Session.confirmNew()}}],App.UI.buildShortcuts=function(){var a=$("#shortcuts");$.each(App.UI.shortcuts,function(b,c){var d=$('<li><a href="#"><i class="icon-'+c.icon+'"></i></a></li>');a.append(d),d.on("click",c.event)}),$("#exit").click(function(){App.Controller.Session.confirmExit()})},App.UI.menu={file:{isDefault:!0,text:"Fichier",items:[{enabled:!0,value:"new",text:"Nouveau",icon:"file-4",event:function(){App.Controller.Session.confirmNew()}},{enabled:!0,value:"open",text:"Ouvrir",icon:"folder-open",event:function(){App.Controller.Session.open()}},{enabled:!0,value:"save",text:"Enregistrer",icon:"upload-3",event:function(){App.Controller.Session.save()}},{enabled:!0,value:"saveas",text:"Enregistrer sous",icon:"upload-3",event:function(){App.Controller.Session.openSaveAs()}},{enabled:!0,value:"print",text:"Imprimer",icon:"print",event:function(){App.Controller.Session.openPrint()}},{enabled:!0,value:"exit",text:"Quitter",icon:"switch",event:function(){App.Controller.Session.confirmExit()}}]},query:{text:"Requêtage",items:[{enabled:!0,value:"add",text:"Ajouter",icon:"plus",event:function(){App.Controller.Query.dialog()}},{enabled:!0,value:"play",text:"Lecture",icon:"play-2",event:function(){App.Controller.Session.compute(function(){},function(){})}},{enabled:!0,value:"stop",text:"Arrêt",icon:"stop"},{enabled:!0,value:"createNodeModel",text:"Modèles de noeud",icon:"file",event:function(){App.Controller.Node.openCreateNodeModel()}}]},tools:{text:"Outils",items:[{enabled:!0,value:"database",text:"Dictionnaire de données",icon:"books",event:function(){App.DataModel.dialog("Base de données",function(){},{commands:{valid:{display:!1},cancel:{display:!1}}})}},{enabled:!0,value:"settings",text:"Préférences",icon:"settings",event:function(){App.Controller.Session.openSettings()}}]},extraction:{text:"Extraction",items:[{enabled:!0,value:"extract",text:"Extraire",icon:"upload-3",event:function(){App.Controller.Session.openExport()}},{enabled:!0,value:"list",text:"Historique",icon:"history",event:function(){App.Controller.Session.openExtractionsList()}}]},help:{text:"?",items:[{enabled:!0,value:"help",text:"Aide",icon:"notebook"},{enabled:!0,value:"about",text:"A propos de",icon:"info",event:function(){App.openAbout()}},{enabled:!0,value:"tutorial",text:"Tutorial",icon:"road"}]}},App.UI.disable=function(){$("#disable").exists()||$("body").prepend('<div id="disable"></div>')},App.UI.enable=function(){$("#disable").remove()},App.UI.error=function(a,b){var c=a,d=new UI.Dialog("Erreur",c,{width:500},function(){});d.open()},App.UI.state=function(){return{synch:{$e:$("#state-synch"),working:function(){this.$e.removeClass("state-error"),this.$e.addClass("state-working"),this.$e.children(".state-text").text("Synchronisation avec le serveur...")},ready:function(){this.$e.removeClass("state-error").removeClass("state-working"),this.$e.children(".state-text").text("Prêt")},fail:function(){this.$e.removeClass("state-ready"),this.$e.removeClass("state-working"),this.$e.addClass("state-error"),this.$e.children(".state-text").text("Echec de la synchronisation")}},save:{$e:$("#state-save"),saved:function(a){this.$e.children(".state-text").text("Dernière sauvegarde le "+a)}}}},App.UI.buildMenu=function(){var a=$("#menu").addClass("flex");$.each(App.UI.menu,function(b,c){var d=$("<li "+(c.isDefault?'class="selected"':"")+'><a data-role="'+b+'" href="#">'+c.text+"</a></li>");a.append(d);var e=$('<ul id="menu-'+b+'" class="submenu"></ul>').addClass("hide");$(c.items).each(function(a,b){if(b.enabled){var c=$('<li><a href="#"><i class="icon-'+b.icon+'"></i><br/><span class="submenu-text">'+b.text+"</span></a></li>");e.append(c),c.on("click",b.event)}}),c.isDefault&&e.removeClass("hide").addClass("flex"),d.click(function(){$("#menu li").removeClass("selected"),$(this).addClass("selected"),$(".submenu").removeClass("flex").addClass("hide"),$("#menu-"+b).removeClass("hide").addClass("flex")}),a.after(e)})},App.UI.session=function(){return{$e:$("#session-name"),saved:function(a){this.$e.text(a),this.$e.css("font-weight","bold")},notSaved:function(a){this.$e.text(a+"*"),this.$e.css("font-weight","normal")}}},App.UI.error=function(a,b){},App.DataModel=function(){},App.DataModel={_mode:"default",_source:[],_attributes:[],_referentials:[],_requests:[],_links:[],_tree:null,_kTree:null,_key:null,_$e:null,schema:function(){return this._source},_schemas:[],_mainSchema:null,_icons:{integer:"calculator2","float":"calculator2",amount:"euro2",percent:"percent",date:"calendar-2",datetime:"calendar-2",string:"spell-check","boolean":"checked-2"},hideEntire:function(){var a=this.kTree();return a.items().each(function(){return"entiere"===a.dataItem(this).element.dataType?($(this).hide(),!1):void 0}),this},root:function(){var a,b=this.kTree();return b.items().each(function(){return""===b.dataItem(this).element.path?(a=$(this),!1):void 0}),a},readElement:function(a,b,c){var d={text:null,encoded:!1,element:{}},e=0,f=this;switch(a[0].nodeName){case"group":d.text='<i class="icon-folder-open"></i> '+a.attr("label"),d.element.label=a.attr("label"),d.element.desc="Groupe de variable '"+d.element.label+"'",d.element.type="group",d.element.name=a.attr("name");break;case"link":if(d=f.read(a.attr("schema"),!1,function(){},a.attr("label"),b+(""==b?"":"/")+a.attr("name"),a.attr("cardinality")),d.element={desc:"Lien vers '"+a.attr("label")+"'",label:a.attr("label"),type:"link",name:a.attr("name"),schema:a.attr("schema"),referential:void 0==a.attr("type")?!1:"referential"==a.attr("type"),hugeData:void 0==a.attr("hugeData")?!1:"true"==a.attr("hugeData"),keyName:a.children("join").attr("target"),linkCardinality:a.attr("cardinality")},d.element.referential){var g=!1;if($.each(f._referentials,function(a,b){return b.schema()==d.element.schema?(g=!0,!1):void 0}),!g){var h=new DataReferential(d.element.schema,d.element.keyName);f._referentials.push(h)}d.element.path=b+(""==b?"":"/")+"@"+a.children("join").attr("source")}else d.element.path=b+(""==b?"":"/")+a.attr("name");this._attributes.push(new Attribute(d.element));break;case"attribute":var i=[];d.element={dataType:a.attr("type"),format:void 0==a.attr("format")?null:a.attr("format"),label:a.attr("label"),path:b+(""==b?"":"/")+"@"+a.attr("name"),type:"attribute",name:a.attr("name"),linkCardinality:c,query:"false"!==a.attr("query")},d.element.desc="Variable '"+d.element.label+"' ("+d.element.path+") de type '"+d.element.dataType+"'"+(null!=d.element.format?" (format '"+d.element.format+"')":""),d.text=a.attr("label"),a.children("enum").length&&(a.children("enum").children().each(function(a,b){i.push({value:$(b).attr("value"),label:$(b).attr("label")+" ("+$(b).attr("value")+")"})}),d.element["enum"]=i);var j=new Attribute(d.element);this._attributes.push(j)}return a.children().not("join, enum").length>0&&(d.items=[],a.children().not("join").each(function(){"true"!=$(this).attr("advanced")&&(d.items[e]=f.readElement($(this),b),e++)})),d},load:function(a,b){var c=this;c._requests.push(App.Server.DataModel.load(function(b){var d=$(b).find("schema"),e=$(b).find("schemas");c._mainSchema=e.attr("main"),d.each(function(a,b){c._schemas[$(b).attr("name")]=b}),a()},function(a){}))},read:function(a,b,c,d,e,f){var g,h=this,i=$(h._schemas[a]),j=0;return g={text:'<i class="icon-'+("multiple"==f?"tree":"books")+'"></i> '+(void 0==d?i.attr("label"):d),encoded:!1,expanded:void 0==e,items:[],element:{path:void 0==e?"":e,cardinality:void 0==f?null:f,key:null}},i.children().not("key").each(function(){$(this).attr("advanced")||(g.items[j]=h.readElement($(this),g.element.path,g.element.cardinality),j++),j+1==i.children().not("key").length&&void 0!=c&&c()}),g.element.key=i.children("key").children("keyfield").attr("path"),g},key:function(){return this._key},init:function(a){var b=this,c=this.read(this._mainSchema,!0,function(){});this._key=c.element.key;var d={text:'<i class="icon-stackoverflow"></i> Toute la base',encoded:!1,element:{type:"attribute",dataType:"entiere",format:null,label:"Toute la base",path:"@"+this.key(),name:"entiere",linkCardinality:"????"}};this._attributes.push(new Attribute(d.element)),this._source.push(d),this._source.push(c);var e=[];$.each(this._referentials,function(a,b){e.push({schema:b.schema(),keyName:b.keyName()})}),App.Server.DataModel.data(e,function(c){$.each(c,function(a,c){b.referential(a).data(c)}),a()},function(a){console.log(a.responseText)})},tree:function(a){var a=_.defaults(a||{},{dragAndDrop:!1,hideQueryAttrs:!1}),b=$('<div class="datamodel"></div>'),c=$('<div class="datamodel-element-info"><i class="icon-info-2"></i> <span class="datamodel-element-info-text"><span></div>');b.append(c);var d=$('<div class="datamodel-tree"></div>');return d.kendoTooltip({filter:"a.info",width:120,position:"top"}),this._tree=d.kendoTreeView({dragAndDrop:a.dragAndDrop,dataSource:this._source,dataBound:function(b){d.find(".k-item").each(function(b,c){var e=d.data("kendoTreeView").dataItem(c);"attribute"===e.element.type&&a.hideQueryAttrs&&$(c).toggle(e.element.query)})},select:function(a){var b=this.dataItem(a.node).element;c.children(".datamodel-element-info-text").text(b.desc)}}),this._kTree=d.data("kendoTreeView"),b.append(d),this._$e=b,b},kTree:function(){return this._kTree},dialog:function(a,b,c){var d=this,e=new UI.Dialog("Modèle de données",this.tree(c),_.extend({width:600},c),function(){d.kTree().select().length&&b(new Attribute(d.kTree().dataItem(d.kTree().select()).element))});return e.title(a),e.open(),this._tree.find(".k-item").children("div").children("span").dblclick(function(){b(new Attribute(d.kTree().dataItem(d.kTree().select()).element))}),e},attribute:function(a){var b=null;return $.each(this._attributes,function(c,d){return d.path()==a?(b=d,!1):void 0}),b},attributeByName:function(a){var b=null;return $.each(this._attributes,function(c,d){return d.name()==a?(b=d,!1):void 0}),b},link:function(a){var b=null;return $.each(this._links,function(c,d){return d.path==a?(b=d,!1):void 0}),b},referential:function(a){var b=null;return $.each(this._referentials,function(c,d){return d.schema()==a?(b=d,!1):void 0}),b}},App.Plugin=function(){},App.Plugin.load=function(a){parent;if("free"!=a.data.mode){var b={file:["new","open","save","saveas","close","exit"],query:["add"]},c={file:[]},d=["copy","save","edit","remove"],e=["save"];switch(a.data.mode){case"targetEdition":c.file.push({enabled:!0,value:"finished",text:"Enregistrer",icon:"checkmark",event:function(){App.Controller.Session.save(function(){},function(){}),App.Plugin.Pnmanager.saveTarget(function(){},function(){})}});break;case"targetModelEdition":c.file.push({enabled:!0,value:"finished",text:"Enregistrer",icon:"checkmark",event:function(){App.Controller.Session.save(function(){},function(){}),App.Plugin.Pnmanager.saveTargetModel(function(){},function(){})}});break;case"campaignExclusionEdition":c.file.push({enabled:!0,value:"finished",text:"Enregistrer",icon:"checkmark",event:function(){App.Controller.Session.save(function(){App.Plugin.Pnmanager.saveCampaign(function(){})},function(){})}});break;case"campaignExtraction":c.file.push({enabled:!0,value:"extraction",text:"Lancer l'extraction",icon:"box-remove",event:function(){App.Plugin.Pnmanager.openExtraction()}}),d=d.concat(["load"]),e=e.concat(["copy","load","addCriterion","edit","remove","addNode"])}$.each(App.UI.menu.file.items,function(a,c){$.inArray(c.value,b.file)>-1&&(c.enabled=!1)}),$.each(App.UI.menu.query.items,function(a,c){$.inArray(c.value,b.query)>-1&&(c.enabled=!1)}),$.each(App.UI.query,function(a,b){$.inArray(a,d)>-1&&(b.enabled=!1)}),$.each(App.UI.node,function(a,b){$.inArray(a,e)>-1&&(b.enabled=!1)}),$.each(c.file,function(a,b){App.UI.menu.file.items.push(b)})}},App.Plugin.Pnmanager=function(){},App.Plugin.Pnmanager.openExtraction=function(){var a=$('<div class="pnmanager-extract"></div>'),b=$('<div class="pnmanager-extract-text">Saisir la quantité voulue pour chaque cible :</div>').hide(),c=[],d=function(){var a=$('<table class="pnmanager-query-list"></table>').hide();return $.each(App.session.queries(),function(b,d){if(!d.excl()){var e=$('<input class="pnmanager-extract-limit" id="pnmanager-extract-limit-'+d.id()+'" data-id="'+d.id()+'"/>'),f=$("<tr></tr>"),g=$("<td></td>"),h=$("<td></td>"),i=d.$listItem().children(".query-details").clone();i.children(".query-progressbar").remove(),i.children(".query-popcount").children("span").text($.formatNumber(d.popcount(),{format:"#,##0",locale:"fr"})).removeAttr("style").removeClass(),g.append(i),h.append(e),f.append(g).append(h),a.append(f),d.limit(d.popcount()),e.kendoNumericTextBox({format:"#",step:1,min:1,max:d.popcount(),decimals:0,value:d.popcount(),change:function(a){d.limit(e.data("kendoNumericTextBox").value())}}),c.push(e)}}),a};if(App.session.queriesComputed()){var e=d();e.before(b.show()),a.append(b.show()).append(d().show())}else{var f=$('<div class="pnmanager-extract-text"><div class="loading"></div>Calcul des requêtes...</div>');a.append(f),App.Controller.Session.compute(function(){f.fadeOut(function(){var a=d();$(this).replaceWith(a),a.before(b.show()),a.fadeIn(),g.enableValid(!0)})},function(){})}var g=new UI.Dialog("Extraction",a,{width:500,commands:{valid:{enabled:!1}}},function(){g.enableValid(!1),$(c).each(function(a){$(this).data("kendoNumericTextBox").enable(!1)}),a.find(".pnmanager-extract-text").html('<div class="loading"></div>Extraction en cours... <span id="pnmanager-extraction-progress">0%</span>'),App.Plugin.Pnmanager.clearExtraction(function(){App.Plugin.Pnmanager.extract(function(){a.find(".pnmanager-extract-text").html('<i class="icon-checkmark"></i> Extraction terminée').addClass("message-success"),$("#pnmanager-extraction-progress").remove(),clearTimeout(b),g.displayValid(!1),g.cancel({text:"Fermer",icon:"close"})},function(a){});var b=null,c=function(){App.Plugin.Pnmanager.checkExtraction(function(a){var d=$("#pnmanager-extraction-progress");d.text(a+"%"),b=setTimeout(c,5e3)},function(a){})};c()},function(){})},function(){});App.session.queriesComputed()&&g.enableValid(!0),g.open()},App.Plugin.Pnmanager.saveCampaign=function(a,b){var c={id:App.session.exclQuery().internalId(),campaignId:App.session.plugin().data.campaign.id};App.Server.get("/pnmanager/campaign/save",{data:c},a,b)},App.Plugin.Pnmanager.saveTarget=function(a,b){var c={id:App.session.queries()[0].internalId(),targetId:App.session.plugin().data.campaign.targets[0].id,campaignId:App.session.plugin().data.campaign.id};App.Server.get("/pnmanager/target/save",{data:c},a,b)},App.Plugin.Pnmanager.saveTargetModel=function(a,b){var c={id:App.session.queries()[0].internalId(),targetId:App.session.plugin().data.campaign.targets[0].id};App.Server.get("/pnmanager/targetModel/save",{data:c},a,b)},App.Plugin.Pnmanager.checkExtraction=function(a,b){var c={id:App.session.id(),targets:[]};$.each(App.session.queries(),function(a,b){c.targets.push({internalId:b.internalId(),id:b.id(),limit:b.limit()})}),App.Server.get("/pnmanager/campaign/checkExtraction",{data:c},function(b){a(b)},function(a){b(a)})},App.Plugin.Pnmanager.clearExtraction=function(a,b){var c={id:App.session.id()};App.Server.get("/pnmanager/campaign/clearExtraction",{data:c},function(){a()},function(){b()})},App.Plugin.Pnmanager.extract=function(a,b){var c={id:App.session.id(),targets:[]};$.each(App.session.queries(),function(a,b){c.targets.push({internalId:b.internalId(),id:b.id(),limit:b.limit()})}),App.Server.get("/pnmanager/campaign/extract",{data:c},function(){a()},function(){b()})},App.Server=function(){},App.Server.get=function(a,b,c,d){return void 0!=App.account&&(b.auth=App.account.auth),$.get(App.config.server.url+a,b,null,"json").done(c).fail(d)},App.Server.post=function(a,b,c,d){return void 0!=App.account&&(b.auth=App.account.auth),$.post(App.config.server.url+a,b,null,"json").done(c).fail(d)},App.Server.Session=function(){},App.Server.Session.init=function(a,b,c,d){return App.Server.post("/session/init",{username:a,password:b,mode:c},d)},App.Server.Session.load=function(a,b,c){return App.Server.get("/session/load",{data:{id:a}},b,c)},App.Server.Session.save=function(a,b,c,d,e,f){return App.Server.post("/session/save",{id:a,name:b,desc:c,queries:d},e,f)},App.Server.Session["delete"]=function(a,b,c){return App.Server.post("/session/delete",{id:a},b,c)},App.Server.Session.list=function(a,b,c,d){return App.Server.get("/session/list",{data:{token:a.token(),status:b}},c,d)},App.Server.Session["export"]=function(a,b,c,d,e){return App.Server.get("/export/execute",{data:{params:a,paths:b,queries:c}},d,e)},App.Server.Session.exportDl=function(a,b,c){return App.Server.get("/export.txt",{data:{file:a}},b,c)},App.Server.Session.saveSettings=function(a,b,c){return App.Server.post("/settings/save",{data:a},b,c)},App.Server.Session.loadSettings=function(a,b){return App.Server.get("/settings/load",{data:{}},a,b)},App.Server.Query=function(){},App.Server.Query.create=function(a,b,c,d){App.Server.post("/query/create",{token:a.token(),label:b.label()},c,d)},App.Server.Query.compute=function(a,b,c,d,e){App.Server.post("/query/compute",{data:{query:a,includeNodes:b,excludeQueries:c}},d,e)},App.Server.Query.saveModel=function(a,b,c,d,e,f){App.Server.post("/query/model/save",{id:a,label:b,excl:c,nodes:d},e,f)},App.Server.Query.loadModel=function(a,b,c){App.Server.get("/query/model/load",{id:a},b,c)},App.Server.Node=function(){},App.Server.Node.deleteModel=function(a,b,c){App.Server.post("/node/model/delete",{id:a},b,c)},App.Server.Node.saveModel=function(a,b,c,d,e){App.Server.post("/node/model/save",{id:a,label:b,criteria:c},d,e)},App.Server.Node.loadModel=function(a,b,c){App.Server.get("/node/model/load",{id:a},b,c)},App.Server.Node.compute=function(a,b,c,d,e){App.Server.post("/node/compute",{data:{node:a,includeNodes:b,excludeNodes:c}},d,e)},App.Server.Criterion={file:function(a,b,c){return a.append("auth",JSON.stringify(App.account.auth)),$.ajax({url:App.config.server.url+"/criterion/file",type:"POST",processData:!1,contentType:!1,dataType:"json",data:a})},compute:function(a,b,c){App.Server.get("/criterion/compute",{data:a},b,c)}},App.Server.DataModel=function(){},App.Server.DataModel.row=function(a,b,c){App.Server.get("/schema/"+a+"/row",{id:b},c)},App.Server.DataModel.load=function(a,b){return $.ajax({url:App.config.server.url+"/schema/load",data:{auth:App.account.auth}}).done(a).fail(b)},App.Server.DataModel.data=function(a,b,c){return $.ajax({url:App.config.server.url+"/schema/data",data:{auth:App.account.auth,data:a}}).done(b).fail(c)},App.Server.Auth={},App.Server.Auth.login=function(a,b,c,d){App.Server.get("/login",{data:{auth:a,encrypted:b}},c,d)},App.Controller=function(){},App.Controller.Session=function(){},App.Controller.Session.confirmDelete=function(a,b,c){var d=$('<div class="pn-form">Etes-vous sûr de vouloir supprimer la session \''+b+"' ?</div>"),e=new UI.Dialog("Supprimer la session",d,{width:800},function(){App.Controller.Session["delete"](a,c),e.close()});e.open()},App.Controller.Session["delete"]=function(a,b){App.Server.Session["delete"](a,function(a){b()},function(a){console.log(a.responseText)})},App.Controller.Session.disableQueryCommands=function(){App.session.exclQueryExists()&&App.Controller.Query.disable(App.session.exclQuery()),$.each(App.session.queries(),function(a,b){App.Controller.Query.disable(b)})},App.Controller.Session.enableQueryCommands=function(){App.session.exclQueryExists()&&App.Controller.Query.enable(App.session.exclQuery()),$.each(App.session.queries(),function(a,b){App.Controller.Query.enable(b)})},App.Controller.Session.report=function(){if(App.session.queries().length+(null!=App.session.exclQuery()?1:0)>0){var a=function(){var a=[];null!=App.session.exclQuery()&&a.push({label:App.session.exclQuery().label(),count:App.session.exclQuery().popcount()}),$.each(App.session.queries(),function(b,c){a.push({label:c.label(),count:c.popcount()})}),$(location).attr("href",App.config.server.url+"/session/report?"+$.param({auth:App.account.auth})+"&"+$.param({data:{session:{id:App.session.id(),name:App.session.name()},queries:a}}))};if(App.session.queriesComputed())a();else{var b='<div class="pn-form">Le rapport nécessite que les requêtes soient calculées. Voulez-vous lancer le comptage ? Le rapport sera automatiquement téléchargé.</div>',c=new UI.Dialog("Confirmation",b,{width:500},function(){c.close(),App.Controller.Session.compute(function(){a()})});c.open()}}},App.Controller.Session.openPrint=function(){var a=$('<div id="print"></div>'),b=$('<div id="print-queries"></div>');b.append("<h1>Sélectionner les requêtes à imprimer</h1>");var c=[],d=App.session.queries();null!=App.session.exclQuery()&&d.unshift(App.session.exclQuery()),$.each(d,function(a,d){c.push(d.id());var e=$('<div class="print-query">'),f=$('<input id="print-query-'+d.id()+'" type="checkbox"/>');f.attr("checked",!0),f.change(function(){$(this).is(":checked")?c.push(d.id()):c=c.unset(c.indexOf(d.id()))}),e.append(f).append('<label for="print-query-'+d.id()+'">'+d.label()+"</label>"),b.append(e)}),a.append(b);var e=new UI.Dialog("Imprimer",a,{width:1e3},function(){e.close(),window.print()});e.open()},App.Controller.Session.print=function(){},App.Controller.Session.openSettings=function(){var a=$('<div id="settings"></div>');a.append("<ul></ul>"),a.children("ul").append("<li>Général</li>"),a.children("ul").append("<li>Requêtage</li>"),a.children("ul").append("<li>Export</li>");var b=$('<div id="settings-general"> </div>'),c=$('<div id="settings-computing"></div>'),d=$('<div class="export-param" id="settings-computing-computeOnTheFly"></div>'),e=$('<label for="settings-computing-computeOnTheFly-input">Calculer à la volée</label>'),f=$('<input type="checkbox" id="settings-computing-computeOnTheFly-input"/>');f.attr("checked",App.settings.computing.computeOnTheFly),d.append(e).append(f),c.append(d);var g=$('<div class="export-param" id="settings-computing-excludeQueries"></div>'),h=$('<label for="settings-computing-excludeQueries-input">Exclure les requêtes entre-elles</label>'),i=$('<input type="checkbox" id="settings-computing-excludeQueries-input"/>');i.attr("checked",App.settings.computing.excludeQueries),g.append(h).append(i),c.append(g);var j=$('<div id="settings-exports"></div>'),k=$('<div class="export-param" id="export-delimiter"></div>'),l=$('<label for="settings-export-delimiter-input">Délimiteur</label>'),m=$('<input class="k-textbox" id="settings-export-delimiter-input" />');m.val(App.settings["export"].delimiter);var n=$('<div class="export-param" id="export-exportVarName"></div>'),o=$('<label for="settings-export-varname-input">Exporter le nom des variables dans l\'entête du fichier</label>'),p=$('<input type="checkbox" id="settings-export-varname-input"/>');p.attr("checked",App.settings["export"].exportVarName),k.append(l).append(m),n.append(o).append(p),j.append(k).append(n),a.append(b),a.append(c),a.append(j);var q=a.kendoTabStrip({animation:!1}).data("kendoTabStrip");q.select(0);var r=new UI.Dialog("Préférences",a,{width:1e3},function(){var a={computing:{computeOnTheFly:f.is(":checked"),excludeQueries:i.is(":checked")},"export":{delimiter:m.val(),exportVarName:p.is(":checked")}};App.UI.state().synch.working(),App.UI.disable(),App.Server.Session.saveSettings(a,function(){App.UI.state().synch.ready(),App.UI.enable(),App.loadSettings(a),App.session.computeOnTheFly(App.settings.computing.computeOnTheFly),r.close()},function(a){console.log(a.responseText),App.UI.state().synch.fail(),App.UI.enable()})});r.open()},App.Controller.Session.openExport=function(){function a(){0==queries.length||0==paths.length?F.enableValid(!1):F.enableValid(!0)}if(!App.session.queries().length){var b=new UI.Alert("Il n'y a pas de requête à extraire.");return void b.open()}var c=new App.Model.Extraction,d=c.get("settings");d.get("fields").add([{path:"@idindividu",label:"ID individu"},{path:"@clemodulo",label:"Clé modulo"},{path:"@civilite",label:"Civilité"},{path:"@prenom",label:"Prénom"},{path:"@nom",label:"Nom"},{path:"@raisonsociale",label:"Raison sociale"},{path:"@v2",label:"Adresse zone 2"},{path:"@v3",label:"Adresse zone 3"},{path:"@v4",label:"Adresse zone 4"},{path:"@v5",label:"Adresse zone 5"},{path:"@cp",label:"Code postal"},{path:"@acheminement",label:"Ville"},{path:"pays/@text",label:"Pays"},{path:"@code_action",label:"Code Action"}]);var e=Marionette.ItemView.extend({tagName:"li",template:!1,onRender:function(){var a=this;this.$el.text(this.model.get("label")),this.$el.attr("data-cid",this.model.cid);var b=$("<a>",{"class":"remove",html:"<i class='icon-close'></i>"}).prependTo(this.$el);b.on("click",function(){a.trigger("remove",a.model)})}}),f=Marionette.CollectionView.extend({tagName:"ul",childView:e,onAddChild:function(a){var b=this;a.on("remove",function(a){b.collection.remove(a)})},onRender:function(){var a=this;this.$el.sortable({placeholder:"move-placeholder",update:function(b,c){var d=a.collection.get(c.item.attr("data-cid")),e=c.item.index();a.collection.remove(d),a.collection.add(d,{at:e})}})}}),g=new f({collection:c.get("settings").get("fields")}),h=$("<div>"),i=$('<div class="extraction-name"></div>').appendTo(h);$('<label for="extraction-name">Nom de l\'extraction</label>').appendTo(i),$('<input type="text" id="extraction-name" class="k-textbox"/>').appendTo(i).on("change",function(){c.set("name",$(this).val())});var j=$('<div class="extraction-filename"></div>').appendTo(h);$('<label for="extraction-filename">Nom du fichier</label>').appendTo(j),$('<input type="text" id="extraction-filename" class="k-textbox"/>').appendTo(j).on("change",function(){c.set("filename",$(this).val())});var k=$('<div class="extraction-limit"></div>').appendTo(h);$('<label for="extraction-limit-label">Limiter la quantité</label>').appendTo(k),$('<input id="extraction-limit-input" />').appendTo(k).kendoNumericTextBox({min:0,value:c.get("limit")}).on("change",function(){c.set("limit",$(this).val()?$(this).val():null)});var l=$('<div id="export"></div>').appendTo(h);l.append("<ul>"),l.children("ul").append("<li>Variables</li>"),l.children("ul").append("<li>Cibles</li>"),l.children("ul").append("<li>Paramètres</li>");var m=$('<div id="export-variables"></div>'),n=$("<div></div>").css("display","-webkit-flex"),o=App.DataModel,p=o.tree().attr("id","export-selection-vars").width("50%");o._tree.height("400px");var q=$('<div id="export-selected-vars"></div>').width("50%");q.append("<h1>Variable(s) sélectionnée(s)</h1>"),q.append(g.render().$el),n.append(p).append(q),o._$e.prepend("<h1>Sélectionner les variables</h1>"),m.append(n),l.append(m),o.hideEntire(),o.kTree().insertBefore({text:"Nom requête / Code Action",element:{label:"Nom requête / Code Action",name:"code_action",desc:"Nom requête / Code Action",path:"@code_action",type:"special"}},o.root()),o._tree.find(".k-item").children("div").children("span").dblclick(function(){var a=o.kTree().dataItem(o.kTree().select());"attribute"!==a.element.type&&"special"!==a.element.type||c.get("settings").get("fields").find(function(b){return b.get("path")===a.element.path})||c.get("settings").get("fields").add({path:a.element.path,label:a.element.label})});var r=$('<div id="export-queries"></div>');r.append("<h1>Sélectionner les requêtes à exporter</h1>");var s=[];$.each(App.session.queries(),function(b,c){if(!c.excl()){d.get("targets").push({queryId:c.id(),code:c.label()});var e=$('<div class="export-query">'),f=$('<input data-id="'+c.id()+'" id="export-query-'+c.id()+'" type="checkbox"/>');f.attr("checked",!0),e.append(f).append('<label for="export-query-'+c.id()+'">'+c.label()+"</label>"),r.append(e),s.push(f),f.change(function(){d.set("targets",_.map(_.filter(s,function(a){return a.prop("checked")===!0}),function(a){return a.attr("data-id")})),a()})}}),l.append(r);var t=$('<div id="export-parameters"></div>');t.append("<h1>Paramètres de l'export</h1>");var u=$('<div class="export-param" id="export-delimiter"></div>'),v=$('<label for="export-varname-input">Exporter le nom des variables dans l\'entête du fichier</label>'),w=$('<input type="checkbox" id="export-varname-input"/>');w.prop("checked",d.get("header")),w.on("change",function(){d.set("enclosure",$(this).prop("checked"))}),u.append(v).append(w),t.append(u);var x=$('<div class="export-param" id="export-delimiter"></div>'),y=$('<label for="export-delimiter-input">Champ délimité par</label>'),z=$('<input class="k-textbox" id="export-delimiter-input" />');z.val(d.get("delimiter")),z.on("change",function(){d.set("delimiter",$(this).val())}),x.append(y).append(z),t.append(x);var A=$('<div class="export-param" id="export-enclosure"></div>'),B=$('<label for="export-delimiter-input">Champs entournés par</label>'),C=$('<input class="k-textbox" id="export-enclosure-input" />');
C.val(d.get("enclosure")),C.on("change",function(){d.set("enclosure",$(this).val())}),A.append(B).append(C),t.append(A),l.append(t);var D=l.kendoTabStrip({animation:!1}).data("kendoTabStrip");D.select(0);var E=$('<div id="export-message"></div>').hide();l.append(E);var F=new UI.Dialog("Export de fichier",h,{width:1e3,commands:{valid:{text:"Lancer l'extraction",enabled:!0}}},function(){var a;if(c.has("name")?c.has("filename")?c.get("settings").get("fields").length?c.get("settings").has("delimiter")||(a="Le délimiteur de champ est obligatoire."):a="Il n'y a pas de champ en sortie.":a="Le nom du fichier est obligatoire.":a="Le nom de l'extraction est obligatoire.",a){var b=new UI.Alert(a,"Attention");return void b.open()}F.enableValid(!1);var d=function(){var a=c.has("limit")&&c.get("limit")<=App.session.popcount()?c.get("limit"):App.session.popcount(),b=new UI.Confirm("Vous êtes sur le point d'extraire "+a+" individus. Continuer et procéder à l'extraction ?",function(){if(App.session.queries().length>0||App.session.exclQuery()){var a=[];null!=App.session.exclQuery()&&a.push(App.session.exclQuery().toJSON()),$.each(App.session.queries(),function(b,c){a.push(c.toJSON())}),App.UI.state().synch.working(),App.UI.disable(),App.session.name(c.get("name")),App.Server.Session.save(App.session.id(),App.session.name(),"Description",a,function(a){App.UI.session().saved(App.session.name()),App.Controller.Session.synchInternalIds(a),App.UI.state().synch.ready(),App.UI.enable()},function(a){console.log(a.responseText),App.UI.state().synch.fail(),App.UI.enable()})}c.set("sessionId",App.session.id()),c.set("description",App.session.toString()),c.save().done(function(){App.Controller.Session.openExtractionsList({check:c})}),console.log("extraction",c)},function(){});b.open()};if(E.removeClass("message-success"),E.fadeIn(),App.session.queriesComputed())F.close(),d();else{F.close();var e=new UI.Alert("Calcul des requêtes...","Extraction");e.displayValid(!1),e.open(),e.k().wrapper.find(".k-window-actions").remove(),App.Controller.Session.compute(function(){e.close(),d()})}});F.open()},App.Controller.Session.openExtractionsList=function(a){function b(a){for(var b=["o","Ko","Mo","Go","To","Po","Eo","Zo","Yo"],c=0;a>=1024;)a/=1024,++c;return a.toFixed(1)+" "+b[c]}function c(){d||e.fetch().done(function(){_.delay(c,5e3)})}var d=!1,e=new App.Model.ExtractionCollection;e.comparator=function(a){return-a.id},c();var f=Marionette.ItemView.extend({tagName:"tr",bindings:{"#extraction-status":{observe:"state",update:function(a,b){a.removeClass().addClass("extraction-"+b)}},"#extraction-status-icon":{observe:"state",onGet:function(a){var b;switch(a){case"edition":b="pencil";break;case"pending":b="play-3";break;case"running":b="play-3";break;case"completed":b="checkmark";break;case"failed":b="warning"}return b},update:function(a,b){a.removeClass().addClass("icon-"+b)}},"#extraction-status-text":{observe:"state",onGet:function(a){var b;switch(a){case"edition":b="en édition";break;case"pending":b="extraction en attente";break;case"running":b="extraction en cours";break;case"completed":b="terminée";break;case"failed":b="échec"}return b}},"#extraction-dl-link":{observe:["state","createdAt"],visible:function(a){return"completed"===a[0]&&moment.duration(moment().diff(moment(a[1]))).asDays()<=30}},"#extraction-payment-icon":{observe:"paymentStatus",update:function(a,b){a.empty(),a.removeClass().addClass("icon-"+("received"===b?"checkmark":"warning"))}},"#extraction-payment-text":{observe:"paymentStatus",onGet:function(a,b){return"received"===b?"payé":"à payer"}},"#extraction-quantity":{observe:"quantity",onGet:function(a){return numeral(a).format("0,0").replace(/,/g," ")}},"#extraction-limit":{observe:"limit",onGet:function(a){return a?numeral(a).format("0,0").replace(/,/g," "):"-"}},"#extraction-filename":"filename","#extraction-name":"name","#extraction-date":{observe:"createdAt",onGet:function(a){return moment(a,"YYYY-MM-DD HH:mm:SS").format("DD/MM/YYYY HH:mm")}},"#extraction-filesize":{observe:"fileSize",onGet:function(a){return a?b(this.model.get("fileSize")):void 0}}},template:function(a){return _.template('        <td id="extraction-name"></td>\n        <td id="extraction-filename"></td>\n        <td id="extraction-date"></td>\n        <td id="extraction-limit" class="extraction-list-limit"></td>\n        <td id="extraction-quantity" class="extraction-list-quantity"></td>\n        <td id="extraction-status" class="extraction-status">\n          <i id="extraction-status-icon"></i>\n          <span id="extraction-status-text"></span>\n        </td>\n        <!--<td class="extraction-payment">\n          <i id="extraction-payment-icon"></i>\n          <span id="extraction-payment-text"></span>\n        </td>-->\n        <td id="extraction-dl">\n          <span id="extraction-dl-link"><a class="link">Télécharger le fichier (<span id="extraction-filesize"></span>)</a><br/></span>\n          <a id="extraction-desc-link" href="#" class="link">Voir la requête de sélection</a>\n          <!--<button class="k-button" id="extraction-open-session">Ouvrir</button>-->\n        </td>')(a)},onRender:function(){var a=this;this.stickit(),this.$("#extraction-dl-link > .link").attr("href",App.config.server.url+"/extractions/"+this.model.id+"/file?"+$.param({auth:App.account.auth})),this.$("#extraction-open-session").on("click",function(){}),this.$("#extraction-desc-link").on("click",function(){var b=new UI.Alert(a.model.get("description")||"Requête indisponible","Requête de sélection");b.open()})}}),g=Marionette.CollectionView.extend({tagName:"tbody",childView:f}),h=Marionette.ItemView.extend({tagName:"table",className:"extraction-list",template:!1,onRender:function(){var a=$("<tr>").appendTo($("<thead>").appendTo(this.$el)),b=[{name:"name",text:"Nom"},{name:"filename",text:"Fichier"},{name:"created_at",text:"Date"},{name:"limit",text:"Quantité demandée"},{name:"quantity",text:"Quantité réelle"},{name:"state",text:"Statut de l'extraction"},{name:"dl",text:""}];_.each(b,function(b){a.append($("<th>",{text:b.text,"class":"extraction-list-"+b.name}))});var c=(a.append($("<th>",{"class":"extraction-list-dl"})),new g({collection:this.options.collection}));c.render().$el.appendTo(this.$el)}}),i=new h({collection:e});i.render();var j=new UI.Dialog("Historique des extractions",i.$el,{width:1e3,commands:{valid:{text:"Fermer"},cancel:{display:!1}}},function(){d=!0,j.close()});j.open(),j.k().bind("close",function(){d=!0})},App.Controller.Session.exit=function(){window.location.reload()},App.Controller.Session.confirmExit=function(){var a="<div>Etes-vous sûr de vouloir quitter la session ?</div>",b=new UI.Dialog("Quitter",a,{width:800,commands:{valid:{text:"Oui"},cancel:{text:"Non"}}},function(){App.Controller.Session.exit(),b.close()});b.open()},App.Controller.Session.confirmNew=function(){var a=$('<div class="pn-form">La session en cours sera perdue, voulez-vous continuer ?</div>'),b=new UI.Dialog("Nouvelle session",a,{width:800},function(){App.Controller.Session["new"](),b.close()});b.open()},App.Controller.Session["new"]=function(a,b){void 0!=App.session&&App.Controller.Session.clear(),App.session=new Session,void 0!=a?App.Controller.Session.load(a,b):(App.session.name("Nouvelle session"),void 0!=b&&b(),App.UI.session().notSaved(App.session.name())),void 0!=App.session&&App.Controller.Session.clear(),App.session=new Session,App.session.name("Nouvelle session"),App.session.computeOnTheFly(App.settings.computing.computeOnTheFly),App.UI.session().notSaved(App.session.name())},App.Controller.Session.clear=function(){$.each(App.session.queries(),function(a,b){b.remove()}),null!=App.session.exclQuery()&&App.session.exclQuery().remove(),App.session.resetQueries()},App.Controller.Session.load=function(a,b){App.UI.state().synch.working(),App.UI.disable(),App.Server.Session.load(a,function(a){App.session=new Session,App.session.name(a.name),null!=a.plugin.name&&(App.session.plugin(a.plugin.name,a.plugin.data),App.Plugin.load(App.session.plugin())),App.session.saved(!0).id(a.id).name(a.name),App.UI.session().saved(a.name),b(),$.each(a.queries,function(a,b){App.Controller.Query.load(b)}),App.session.exclQueryExists()?App.session.exclQuery().select():null!=App.session.queries()[0]&&App.session.queries()[0].select();var c=App.settings.computing.computeOnTheFly;if(c){var d=App.session.exclQuery();null!=d&&(d.nodes().length>1?c=!1:d.nodes()[0].criteria().length>0&&(c=!1)),c&&$.each(App.session.queries(),function(a,b){b.nodes().length>1?c=!1:b.nodes()[0].criteria().length>0&&(c=!1)})}App.session.computeOnTheFly(c),App.UI.state().synch.ready(),App.UI.enable()},function(a){console.log(a.responseText),App.UI.state().synch.fail(),App.UI.enable()})},App.Controller.Session.openSaveAs=function(a){if(App.session.queries().length>0||App.session.exclQuery()){var b=$('<div class="pn-form"></div>'),c=$('<div class="pn-form-input-wrap"></div>'),d=$('<label for="file-save-session-name">Nom</label>'),e=$('<input size="200" id="file-save-session-name" class="k-textbox" placeholder="Nom" type="text"/>');c.append(d).append(e),e.val(App.session.name()),e.css("width","400px");var f=App.Controller.Session.list();b.append(f).append(c);var g=new UI.Dialog("Enregistrer sous",b,{width:800},function(){var a=(f.data("kendoGrid"),null);App.session.name(e.val()),App.Controller.Session.saveAs(a),g.close()});g.open()}},App.Controller.Session.open=function(){var a=$('<div class="pn-form"></div>'),b=$('<div class="session-open-commands"></div>'),c=$('<button id="session-delete" class="k-button"><i class="icon-close"></i> Supprimer</button>'),d=($('<div class="pn-form-input-wrap"></div>'),App.Controller.Session.list());b.append(c),a.append(b).append(d),c.click(function(){var a=d.data("kendoGrid");if(a.select().length>0){var b=a.dataItem(a.select()[0]);App.Controller.Session.confirmDelete(b.id,b.name,function(){var c=a.dataSource.get(b.id);a.dataSource.remove(c)})}});var e=new UI.Dialog("Ouvrir une session",a,{width:800},function(){var a=d.data("kendoGrid"),b=null;a.select().length>0&&(b=a.dataItem(a.select()[0]).id),App.Controller.Session.confirmOpen(b),e.close()});e.open()},App.Controller.Session.synchInternalIds=function(a){App.session.id(a.id),$.each(a.queries,function(a,b){null==App.session.query(b.id)?App.session.exclQuery().internalId(b.internalId):App.session.query(b.id).internalId(b.internalId)})},App.Controller.Session.confirmOpen=function(a){var b=$('<div class="pn-form">La session en cours sera perdue, voulez-vous continuer ?</div>'),c=new UI.Dialog("Ouvrir une session",b,{width:800},function(){void 0!=App.session&&App.Controller.Session.clear(),App.Controller.Session.load(a,function(){}),c.close()});c.open()},App.Controller.Session.saveAs=function(a){App.UI.state().synch.working(),App.UI.disable();var b=[];return null!=App.session.exclQuery()&&b.push(App.session.exclQuery().toJSON()),$.each(App.session.queries(),function(a,c){b.push(c.toJSON())}),App.Server.Session.save(a,App.session.name(),"Description",b,function(a){App.session.saved(!0),App.Controller.Session.synchInternalIds(a),App.UI.session().saved(App.session.name()),App.UI.state().synch.ready(),App.UI.enable()},function(a){console.log(a.responseText),App.UI.state().synch.fail(),App.UI.enable()})},App.Controller.Session.save=function(a,b){if(App.session.queries().length>0||App.session.exclQuery()){var c=[];null!=App.session.exclQuery()&&c.push(App.session.exclQuery().toJSON()),$.each(App.session.queries(),function(a,b){c.push(b.toJSON())}),App.session.isSaved()?(App.UI.state().synch.working(),App.UI.disable(),App.Server.Session.save(App.session.id(),App.session.name(),"Description",c,function(b){App.session.saved(!0),App.Controller.Session.synchInternalIds(b),App.UI.session().saved(App.session.name()),void 0!=a&&a(),App.UI.state().synch.ready(),App.UI.enable()},function(a){console.log(a.responseText),void 0!=b&&b(),App.UI.state().synch.fail(),App.UI.enable()})):App.Controller.Session.openSaveAs()}},App.Controller.Session.list=function(){var a=$('<div class="pn-list"></div>');return a.kendoGrid({dataSource:{transport:{read:{url:App.config.server.url+"/session/list",data:{auth:App.account.auth}}}},sortable:{mode:"single",allowUnsort:!1},selectable:"row",pageable:{pageSize:5,messages:{display:"{0}/{1} sessions sur {2} au total"}},scrollable:!0,resizable:!0,columns:[{field:"name",title:"Session",width:50},{field:"createdBy",title:"Créé par",width:20},{field:"creationDate",title:"Créé le",width:20},{field:"lastEditionDate",title:"Modifié le",width:20}]}),a},App.Controller.Session.compute=function(a,b){var c=function(){App.session.queries().length>0&&App.Controller.Query.computeFrom(App.session.queries()[0],function(){App.session.computeOnTheFly(!0),a()},b)};null!=App.session.exclQuery()?App.Controller.Query.compute(App.session.exclQuery(),function(){c()},function(){}):c()},App.Controller.Query=function(){},App.Controller.Query.disable=function(a){a.disableCommands(),$.each(a.nodes(),function(a,b){b.disableCommands()})},App.Controller.Query.enable=function(a){a.enableCommands(),$.each(a.nodes(),function(a,b){b.enableCommands()})},App.Controller.Query.confirmLoadModel=function(a,b){var c="<div>Le contenu de la cible sera perdu, êtes-vous sûr de vouloir continuer ?</div>",d=new UI.Dialog(a,c,{width:800,commands:{valid:{text:"Oui"},cancel:{text:"Non"}}},function(){d.close(),b()});d.open()},App.Controller.Query.modelsList=function(a){var b=$('<div class="pn-list"></div>');return b.kendoGrid({change:function(b){void 0!=a&&a(b)},dataSource:{transport:{read:{url:App.config.server.url+"/query/model/list",data:{auth:App.account.auth}}}},sortable:{mode:"single",allowUnsort:!1},selectable:"row",scrollable:!0,resizable:!0,columns:[{field:"label",title:"Modèle",width:50},{field:"excl",title:"Exclusion",width:15},{field:"createdBy",title:"Créé par",width:15},{field:"creationDate",title:"Créé le",width:30},{field:"lastEditionDate",title:"Modifié le",width:30}]}),b},App.Controller.Query.openModelList=function(a,b){var c=$('<div class="pn-form"></div>'),d=App.Controller.Query.modelsList();c.append(d);var e=new UI.Dialog(a,c,{width:800},function(){var a=d.data("kendoGrid"),c=a.dataItem(a.select());b(c),e.close()});e.open()},App.Controller.Query.openLoadModel=function(a){var b=function(b){App.UI.state().synch.working(),App.UI.disable(),App.Server.Query.loadModel(b.id,function(b){var c=JSON.parse(b.nodes);$.each(c,function(b,c){var d=""==c.parent?null:c.parent,e=(""==c.children?null:c.children,""==c.criteria?null:c.criteria);c.parent=null,c.children=[],c.criteria=[];var f=a.addNode(new Node(c));f.query(a),null!=d&&(f.parent(a.node(d)),a.node(d).children().push(f)),f.render(),null!=e&&$.each(e,function(a,b){var c={id:b.id,operator:""!=b.operator?new Operator(b.operator):null,operation:""!=b.operation?new Operation(b.operation):null,typeFunction:""!=b.typeFunction?new TypeFunction(App.DataModel.attribute(b.path).dataType(),b.typeFunction):null,attribute:App.DataModel.attribute(b.path),value:""!=b.value?b.value:null,entiere:"true"==b.entiere},b=new Criterion(c);f.addCriterion(b),b.render()})}),App.session.computeOnTheFly()&&App.Controller.Query.computeFrom(a,function(){},function(){})},function(a){console.log(a.responseText),App.UI.state().synch.fail(),App.UI.enable()})};App.Controller.Query.openModelList("Charger un modèle",function(c){a.nodes().length>0?App.Controller.Query.confirmLoadModel("Confirmation du chargement du modèle",function(){a.$tree().empty(),a._nodes=[],b(c)}):b(c)})},App.Controller.Query.saveModel=function(a,b,c){var d=[];$.each(a.nodes(),function(a,b){d.push(b.toJSON())}),App.Server.Query.saveModel(a.internalId(),a.label(),a.excl(),d,function(a){b(a)},function(a){c(a)})},App.Controller.Query.openSaveModel=function(a){var b=$('<div class="pn-form"></div>'),c=$('<div class="pn-form-input-wrap"></div>'),d=$('<label for="query-model-name">Nom</label>'),e=$('<input id="query-model-name" class="k-textbox"/>');e.val(a.label()),c.append(d).append(e),b.append(c);var f=new UI.Dialog("Enregistrer en tant que modèle",b,{width:500},function(){a.label(e.val()),App.UI.state().synch.working(),App.UI.disable(),App.Controller.Query.saveModel(a,function(){App.UI.state().synch.ready(),App.UI.enable()},function(a){console.log(a.responseText),App.UI.state().synch.fail(),App.UI.enable()}),f.close()});f.$valid().text("Enregistrer"),f.open()},App.Controller.Query.load=function(a){var b=new Query({id:uid(),internalId:a.id,label:a.label,excl:a.excl,exclusivity:a.exclusivity,useExclusion:a.useExclusion,nodes:[]});if(a.excl?App.session.exclQuery(b):App.session.addQuery(b),b.render(!1),null==a.data)App.Controller.Node.add(b,null);else{var c=JSON.parse(a.data);$.each(c,function(a,c){var d=""==c.parent?null:c.parent,e=(""==c.children?null:c.children,""==c.criteria?null:c.criteria);c.parent=null,c.children=[],c.criteria=[];var f=b.addNode(new Node(c));f.query(b),null!=d&&(f.parent(b.node(d)),b.node(d).children().push(f)),f.render(),null!=e&&$.each(e,function(a,b){var c={id:b.id,operator:""!=b.operator?new Operator(b.operator):null,operation:""!=b.operation?new Operation(b.operation):null,typeFunction:""!=b.typeFunction?new TypeFunction(App.DataModel.attribute(b.path).dataType(),b.typeFunction):null,attribute:App.DataModel.attribute(b.path),value:""!=b.value?b.value:null,entiere:"true"==b.entiere},b=new Criterion(c);f.addCriterion(b),b.render()})})}},App.Controller.Query.dialog=function(a){var b=null,c=$('<div class="pn-form"></div>'),d=$('<div class="pn-form-input-wrap"></div>'),e=$('<label for="query-name">Nom / Code Action</label>'),f=$('<input id="query-name" class="k-textbox"/>').val(null!=a?a.label():"Cible "+(App.session.queries().length+1)),g=$('<div class="pn-form-input-wrap"></div>'),h=$('<label for="query-desc">Description</label>'),i=$('<textarea rows="10" id="query-desc" class="k-textbox"></textarea>'),j=$('<div class="pn-form-input-wrap"></div>'),k=$('<label for="query-exclusionType">Exclusion</label>'),l=$('<input type="checkbox" id="query-exclusionType"/>').css("width","inherit");d.append(e).append(f),g.append(h).append(i),j.append(k).append(l),l.on("change",function(){$(this).prop("checked")?(b=f.val(),f.val("Exclusion")):f.val(a?a.label():"Cible "+(App.session.queries().length+1))});var m=$('<div class="pn-form-input-wrap"></div>'),n=$('<label for="query-exclusivity">Exclusivité avec les cibles précédentes</label>'),o=$('<input type="checkbox" id="query-exclusivity"/>').css("width","inherit").attr("checked",!0);m.append(n).append(o);var p=$('<div class="pn-form-input-wrap"></div>'),q=$('<label for="query-useExclusion">Utiliser l\'exclusion</label>'),r=$('<input type="checkbox" id="query-useExclusion"/>').css("width","inherit").attr("checked",!0);p.append(q).append(r),c.append(d).append(g).append(j).append(m).append(p),null!=a?a.excl()?(l.attr("checked",!0),m.hide(),p.hide()):(o.attr("checked",a.exclusivity()),r.attr("checked",a.useExclusion())):(o.attr("checked",!0),r.attr("checked",!0)),App.session.exclQueryExists()&&(null!=a&&a.excl()===!1||null==a)&&(k.addClass("disabled"),l.attr("disabled","disabled")),l.click(function(){$(this).is(":checked")?(m.hide(),p.hide()):(m.show(),p.show())});var s=new UI.Dialog(null!=a?a.label():"Nouvelle cible",c,{width:800},function(){if(null!=a){if(l.is(":checked"))a.excl()||(App.session._queries=App.session.queries().unset(App.session.queries().indexOf(a)),a.excl(!0),App.session.exclQuery(a));else if(a.excl())App.session._exclQuery=null;else{var b=function(){a.exclusivity(o.is(":checked")),a.useExclusion(r.is(":checked"))};a.exclusivity()==o.is(":checked")&&a.useExclusion()==r.is(":checked")||!App.session.computeOnTheFly()?b():(b(),App.Controller.Query.computeFrom(a,function(){},function(){}))}a.label(f.val()).desc(i.val()).excl(l.is(":checked")).updateLabel(),a.excl()?a.$toExcl():a.$toDefault()}else App.Controller.Query.add(f.val(),i.val(),l.is(":checked"),o.is(":checked"),r.is(":checked"));s.close()});s.open()},App.Controller.Query.remove=function(a){var b=new UI.Confirm("Etes-vous de vouloir supprimer la cible '"+a.label()+"' ?",function(){a.remove();var b=null;if(a.excl()){var b=App.session.queries()[0];App.session._exclQuery=null}else{var b=a.next();App.session._queries=App.session.queries().unset(App.session.queries().indexOf(a))}a.excl()?App.session.computeOnTheFly()&&App.session.queries().length>0&&App.Controller.Query.computeFrom(b,function(){},function(){}):App.session.computeOnTheFly()&&null!=b&&App.Controller.Query.computeFrom(b,function(){},function(){})},function(){});b.open()},App.Controller.Query.add=function(a,b,c,d,e){var f=new Query({id:uid(),label:a,desc:b,excl:c,exclusivity:d,useExclusion:e,popcount:null,nodes:[]});c?App.session.exclQuery(f):App.session.addQuery(f),f.render(null,function(){f.select()}),App.Controller.Node.add(f,null)},App.Controller.Query.computeNodes=function(a,b,c){App.Controller.Node.computeFrom(a.mainNode(),function(a){b(a)},function(a){c(a)})},App.Controller.Query.computeFrom=function(a,b,c){App.Controller.Session.disableQueryCommands(),App.Controller.Query.compute(a,function(c){a.hasNext()?App.Controller.Query.computeFrom(a.next(),function(){b(c)},function(){}):a.excl()&&App.session.queries().length>0&&App.Controller.Query.computeFrom(App.session.queries()[0],function(){b(c)},function(){}),a.hasNext()||(b(c),App.Controller.Session.enableQueryCommands())},function(a){c(a)})},App.Controller.Query.compute=function(a,b,c){a.disableCommand("edit").disableCommand("remove");var d=function(){a.compute(function(c){e++,a.progress(Math.floor(100*e/f)),a.updatePopcount(function(){a.hideProgressbar().resetProgress()}),b(c)},function(a){console.log(a.responseText),void 0!=c&&b(a)})},e=0;if(a.progress(0),a.showProgressbar(),a.nodesComputed()){var f=1;d()}else{var f=a.nodes().length+1;App.Controller.Node.computeFrom(a.mainNode(),function(a){d()},function(a){},function(){e++,a.progress(Math.floor(100*e/f))})}},App.Controller.Node=function(){},App.Controller.Node.deleteModel=function(a,b,c){App.UI.state().synch.working(),App.UI.disable(),App.Server.Node.deleteModel(a,function(a){App.UI.state().synch.ready(),App.UI.enable(),b(a)},function(a){console.log(a.responseText),App.UI.state().synch.fail(),App.UI.enable(),c(a)})},App.Controller.Node.openSaveModel=function(a){a._internalId=null;var b=$('<div class="pn-form"></div>'),c=$('<div class="pn-form-input-wrap"></div>'),d=$('<label for="node-model-name">Nom</label>'),e=$('<input id="node-model-name" class="k-textbox"/>');c.append(d).append(e),b.append(c);var f=new UI.Dialog("Enregistrer en tant que modèle",b,{width:500},function(){a.label(e.val()),App.UI.state().synch.working(),App.UI.disable(),App.Controller.Node.saveModel(a,function(){App.UI.state().synch.ready(),App.UI.enable()},function(a){console.log(a.responseText),App.UI.state().synch.fail(),App.UI.enable()}),f.close()});f.$valid().text("Enregistrer"),f.open()},App.Controller.Node.confirmLoadModel=function(a,b){var c="<div>Le contenu du noeud sera perdu, êtes-vous sûr de vouloir continuer ?</div>",d=new UI.Dialog(a,c,{width:800,commands:{valid:{text:"Oui"},cancel:{text:"Non"}}},function(){d.close(),b()});d.open()},App.Controller.Node.openLoadModel=function(a){var b=function(b){App.Server.Node.loadModel(b.id,function(b){var c=JSON.parse(b.criteria);null!=c&&$.each(c,function(b,c){var d={id:uid(),operator:null!=c.operator?new Operator(c.operator):null,operation:null!=c.operation?new Operation(c.operation):null,typeFunction:null!=c.typeFunction?new TypeFunction(App.DataModel.attribute(c.path).dataType(),c.typeFunction):null,attribute:App.DataModel.attribute(c.path),value:c.value},c=new Criterion(d);a.addCriterion(c),c.render()}),App.session.computeOnTheFly()&&App.Controller.Node.computeFrom(a,function(){App.Controller.Query.computeFrom(a.query(),function(){},function(){})},function(){})},function(a){console.log(a.responseText),App.UI.state().synch.fail(),App.UI.enable()})};App.Controller.Node.openModelList("Charger un modèle",function(c){a._criteria.length>0?App.Controller.Node.confirmLoadModel("Confirmation du chargement du modèle",function(){a.emptyCriteria(),b(c)}):b(c)})},App.Controller.Node.openModelList=function(a,b){var c=$('<div class="pn-form"></div>'),d=App.Controller.Node.modelsList();c.append(d);var e=new UI.Dialog(a,c,{width:800},function(){var a=d.data("kendoGrid"),c=a.dataItem(a.select());b(c),e.close()});e.open()},App.Controller.Node.modelsList=function(a){var b=$('<div class="pn-list"></div>');return b.kendoGrid({change:function(b){void 0!=a&&a(b)},dataSource:{transport:{read:{url:App.config.server.url+"/node/model/list",data:{auth:App.account.auth}}}},sortable:{mode:"single",allowUnsort:!1},selectable:"row",scrollable:!0,resizable:!0,columns:[{field:"label",title:"Modèle",width:50},{field:"createdBy",title:"Créé par",width:20},{field:"creationDate",title:"Créé le",width:20},{field:"lastEditionDate",title:"Modifié le",width:20}]}),b},App.Controller.Node.saveModel=function(a,b,c){var d=[];$.each(a.criteria(),function(a,b){d.push(b.toJSON())}),App.Server.Node.saveModel(a.internalId(),a.label(),JSON.stringify(d),function(a){b(a)},function(a){c(a)})},App.Controller.Node.openCreateNodeModel=function(){var a=new Node({id:uid(),criteria:[]}),b=$('<div id="node-model" class="pn-form"></div>'),c=$('<div id="node-model-details"></div>'),d=$('<div id="node-model-commands"></div>'),e=$('<button id="node-model-new" class="k-button"><i class="icon-file-4"></i> Nouveau</button>');e.click(function(){a.label("Nouveau modèle de noeud"),a._criteria=[],a._internalId=null,j.val(a.label()),h.show(),k.empty().show()});var f=$('<button id="node-model-delete" class="k-button"><i class="icon-close"></i> Supprimer</button>');f.click(function(){null!=a.internalId()&&App.Controller.Node.deleteModel(a.internalId(),function(){var b=l.data("kendoGrid"),c=b.dataSource.get(a.internalId());b.dataSource.remove(c)})});var g=$('<button id="node-model-criterion-add" class="k-button"><i class="icon-filter-2"></i> Ajouter un critère</button>');d.append(e).append(f).append(g);var h=$('<div class="pn-form-input-wrap"></div>'),i=$('<label for="node-model-label">Nom</label>'),j=$('<input id="node-model-label" class="k-textbox"/>');h.hide().append(i).append(j);var k=$('<div id="node-model-criteria"></div>');c.append(d).append(h).append(k);var l=App.Controller.Node.modelsList(function(b){var c=l.data("kendoGrid"),d=c.dataItem(c.select());App.UI.state().synch.working(),App.UI.disable(),App.Server.Node.loadModel(d.id,function(b){h.show(),j.val(b.label),a.internalId(b.id).label(b.label),a._criteria=[];var c=JSON.parse(b.criteria);k.empty(),null!=c&&$.each(c,function(b,c){var d={id:c.id,operator:null!=c.operator?new Operator(c.operator):null,operation:null!=c.operation?new Operation(c.operation):null,typeFunction:null!=c.typeFunction?new TypeFunction(App.DataModel.attribute(c.path).dataType(),c.typeFunction):null,attribute:App.DataModel.attribute(c.path),value:c.value},c=new Criterion(d);a.addCriterion(c);var e=$('<div class="node-model-criterion"><i class="icon-filter-2"></i> '+c.toString()+"</div>"),f=$('<button class="node-model-criterion-remove"><i class="icon-close"></i></button>');e.append(f),e.click(function(){c.dialog(function(){e.html('<i class="icon-filter-2"></i> '+c.toString())},!0).open()}),e.hover(function(){e.addClass("node-model-criterion-hover"),f.show()},function(){e.removeClass("node-model-criterion-hover"),f.hide()}),f.hide().click(function(){e.off("click"),a.removeCriterion(c),e.remove()}),k.append(e)}),k.show(),App.UI.state().synch.ready(),App.UI.enable()},function(a){console.log(a.responseText),App.UI.state().synch.fail(),App.UI.enable()})});l.css("width","50%"),b.append(l).append(c).addClass("flex"),g.click(function(){var b=new Criterion,c=b.dialog(function(){a.addCriterion(b);var c=$('<div class="node-model-criterion"><i class="icon-filter-2"></i> '+b.toString()+"</div>");c.click(function(){b.dialog(function(){}).open()}),c.hover(function(){c.addClass("node-model-criterion-hover"),d.show()},function(){c.removeClass("node-model-criterion-hover"),d.hide()}),k.append(c);var d=$('<button class="node-model-criterion-remove"><i class="icon-close"></i></button>');c.append(d),d.hide().click(function(){c.off("click"),a.removeCriterion(b),c.remove()})});c.open()});var m=new UI.Dialog("Modèle de noeud",b,{width:1e3},function(){a.label(j.val()),App.Controller.Node.saveModel(a,function(){App.UI.state().synch.ready(),App.UI.enable()},function(a){console.log(a.responseText),App.UI.state().synch.fail(),App.UI.enable()}),m.close()});m.$valid().text("Enregistrer"),m.open()},App.Controller.Node.add=function(a,b,c){App.session;if(null==b){var d={label:null==c?"Niveau 1":"Niveau "+c.level()+"-"+(c.hasChildren()?c.last().axis().y+1:1),popcount:null,parent:c,children:[],query:a,criteria:[]};b=new Node(d),b.id(uid()),b.hasParent()&&c.children().push(b),a.addNode(b).render()}else b.parent(c),b.query(a),b.children([]),c.children().push(b),a.addNode(b).render()},App.Controller.Node["delete"]=function(a){var b=new UI.Confirm("Etes-vous de vouloir supprimer le noeud '"+a.label()+"' ?",function(){var b=a.query(),c=null;a.hasChildren()?c=a.first():a.hasNext()&&(c=a.next()),a.query().removeNode(a.remove(function(){b.rebuildLinks()})),null!=c?App.session.computeOnTheFly()&&App.Controller.Node.computeFrom(c,function(){App.Controller.Query.computeFrom(b,function(){},function(){})},function(){}):App.session.computeOnTheFly()&&App.Controller.Query.computeFrom(b,function(){},function(){})});b.open()},App.Controller.Node.computeCriteria=function(a,b,c){a.loading(),$.each(a.criteria(),function(d,e){e.compute(function(c){d==a.criteria().length&&b(c)},function(a){c(a)})})},App.Controller.Node.computeFrom=function(a,b,c,d){App.Controller.Node.compute(a,function(c){a.hasChildren()&&App.Controller.Node.computeFrom(a.first(),function(){b(c)},function(){},d),a.hasNext()&&App.Controller.Node.computeFrom(a.next(),function(){b(c)},function(){},d),a.query().nodesComputed()&&b(c),d&&d()},function(a){c(a)})},App.Controller.Node.compute=function(a,b,c){a.computed(!1);var d=function(){a.compute(function(c){App.UI.error("Erreur survenue pendant le calcul",c.responseText),a.updateCount(),b(c)},function(a){c(a)})};a.loading(),d()},App.Controller.Criterion=function(){},App.Controller.Criterion.add=function(a,b){var c=new Criterion(b);c.id(uid());var d=c.dialog(function(){a.addCriterion(c).render(),App.session.computeOnTheFly()&&App.Controller.Node.computeFrom(a,function(){App.Controller.Query.computeFrom(a.query(),function(){},function(){})},function(){})});d.open()},App.Controller.Criterion.edit=function(a){var b=a.dialog(function(){a.updateRender(),App.session.computeOnTheFly()&&App.Controller.Node.computeFrom(a.node(),function(){App.Controller.Query.computeFrom(a.node().query(),function(){},function(){})},function(){})},!0);b.open()},App.Controller.Criterion["delete"]=function(a){var b=new UI.Confirm("Etes-vous de vouloir supprimer le critère '"+a.toString()+"' ?",function(){a.node().removeCriterion(a.remove()),App.session.computeOnTheFly()&&App.Controller.Node.computeFrom(a.node(),function(){App.Controller.Query.computeFrom(a.node().query(),function(){},function(){})},function(){})});b.open()},App.Controller.Criterion.compute=function(a,b,c){a.node().loading(),a.compute(function(a){b(a)},function(a){console.log(a.responseText),c(a)})},App.Model||(App.Model={});var Field=Backbone.Model.extend({}),FieldCollection=Backbone.Collection.extend({model:Field}),Settings=Backbone.Model.extend({defaults:{delimiter:";",enclosure:"",header:!0,targets:[]},initialize:function(){this.set("fields",new FieldCollection),this.set("targets",[])},toJSON:function(){var a=Backbone.Model.prototype.toJSON.call(this);return a.fields=this.get("fields").toJSON(),a}});App.Model.Extraction=Backbone.Model.extend({defaults:{name:null,filename:null,description:null,limit:null,state:null,paymentStatus:null,sessionId:null},urlRoot:function(){return App.config.server.url+"/extractions"},
sync:function(a,b,c){var d={};return!b||"create"!==a&&"update"!==a&&"patch"!==a||(c.contentType="application/json",d=c.attrs||b.toJSON()),"read"===a?c.data=$.param({auth:App.account.auth}):(_.extend(d,{auth:App.account.auth}),c.data=JSON.stringify(d)),Backbone.sync.call(this,a,b,c)},initialize:function(){this.set("settings",new Settings)},toJSON:function(){var a=Backbone.Model.prototype.toJSON.call(this);return a.settings=this.get("settings").toJSON(),a}}),App.Model.ExtractionCollection=Backbone.Collection.extend({url:function(){var a=$.param({auth:App.account.auth});return App.config.server.url+"/extractions?"+a}});